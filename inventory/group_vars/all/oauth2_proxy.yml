---
# oauth2-proxy - Traefik Forward Auth with Keycloak OIDC
# Deployed on Firewall container (101) together with Traefik

oauth2_proxy_enabled: true
oauth2_proxy_version: "v7.7.1"  # Can pin to specific version
oauth2_proxy_service_port: 4180  # Default oauth2-proxy port
oauth2_proxy_hostname: auth
oauth2_proxy_domain: "{{ public_domain }}"
oauth2_proxy_external_url: "https://{{ oauth2_proxy_hostname }}.{{ oauth2_proxy_domain }}"

# Deployment location: Dedicated container (CT 167) for security isolation
oauth2_proxy_container_id: 167
oauth2_proxy_data_dir: /opt/oauth2-proxy

# Keycloak OIDC Configuration
oauth2_proxy_provider: "keycloak-oidc"
oauth2_proxy_client_id: "{{ vault_oauth2_proxy_client_id }}"
oauth2_proxy_client_secret: "{{ vault_oauth2_proxy_client_secret }}"
oauth2_proxy_cookie_secret: "{{ vault_oauth2_proxy_cookie_secret }}"

# Split-horizon DNS: Use internal IPs for oauth2-proxy→Keycloak, public URLs for browser→Keycloak
oauth2_proxy_oidc_issuer_url: "http://172.16.10.151:8080/realms/master"  # Internal: for token verification
oauth2_proxy_redirect_url: "{{ oauth2_proxy_external_url }}/oauth2/callback"  # External: user browser callback
oauth2_proxy_login_url: "https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/auth"  # External: user browser
oauth2_proxy_redeem_url: "http://172.16.10.151:8080/realms/master/protocol/openid-connect/token"  # Internal: oauth2-proxy backend
oauth2_proxy_profile_url: "http://172.16.10.151:8080/realms/master/protocol/openid-connect/userinfo"  # Internal: oauth2-proxy backend
oauth2_proxy_validate_url: "http://172.16.10.151:8080/realms/master/protocol/openid-connect/userinfo"  # Internal: oauth2-proxy backend
oauth2_proxy_jwks_url: "http://172.16.10.151:8080/realms/master/protocol/openid-connect/certs"  # Internal: JWKS endpoint for token validation

# Session configuration
oauth2_proxy_cookie_domain: ".{{ public_domain }}"  # Wildcard for all subdomains
oauth2_proxy_cookie_secure: true
oauth2_proxy_cookie_httponly: true
oauth2_proxy_cookie_samesite: "lax"
oauth2_proxy_session_store_type: "cookie"
oauth2_proxy_cookie_expire: "168h"  # 7 days
oauth2_proxy_cookie_refresh: "1h"

# Whitelist configuration (only authenticated users allowed by default)
oauth2_proxy_email_domains: "*"  # Allow any email domain
oauth2_proxy_whitelist_domains: "{{ public_domain }},.{{ public_domain }}"

# Upstream configuration (not used in forward auth mode)
oauth2_proxy_upstreams: "static://202"  # Dummy upstream for forward auth mode

# Security settings
oauth2_proxy_skip_provider_button: false  # Show "Sign in with Keycloak" button
oauth2_proxy_pass_authorization_header: true
oauth2_proxy_pass_access_token: true
oauth2_proxy_pass_user_headers: true
oauth2_proxy_set_authorization_header: true
oauth2_proxy_set_xauthrequest: true

# Logging
oauth2_proxy_request_logging: true
oauth2_proxy_auth_logging: true
oauth2_proxy_standard_logging: true

# OIDC specific settings
oauth2_proxy_scope: "openid profile email"
oauth2_proxy_insecure_oidc_allow_unverified_email: false
oauth2_proxy_oidc_groups_claim: "groups"
oauth2_proxy_skip_oidc_discovery: true  # Skip discovery to use manual endpoint configuration (split-horizon DNS)

# Reverse proxy settings (oauth2-proxy behind Traefik)
oauth2_proxy_reverse_proxy: true
oauth2_proxy_real_client_ip_header: "X-Forwarded-For"
