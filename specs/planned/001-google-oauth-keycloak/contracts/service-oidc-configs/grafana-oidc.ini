# Grafana OIDC Configuration
# File: /etc/grafana/grafana.ini
# Restart with: systemctl restart grafana-server

[auth.generic_oauth]
enabled = true
name = Keycloak
allow_sign_up = true
client_id = grafana
client_secret = {{ vault_grafana_oidc_secret }}
scopes = openid email profile offline_access roles
email_attribute_path = email
login_attribute_path = preferred_username
name_attribute_path = name

# Keycloak endpoints
auth_url = https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/auth
token_url = https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/token
api_url = https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/userinfo
signout_redirect_url = https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/logout

# Role mapping (CRITICAL for permissions)
# Maps Keycloak realm roles to Grafana roles
role_attribute_path = contains(realm_access.roles[*], 'grafana-admin') && 'Admin' || contains(realm_access.roles[*], 'grafana-editor') && 'Editor' || 'Viewer'
role_attribute_strict = true

# Allow assigning Grafana Admin role
allow_assign_grafana_admin = true

# Ensure role sync happens on login
skip_org_role_sync = false
oauth_skip_org_role_update_sync = false

# Auto-login (optional)
auto_login = false

# Use PKCE for enhanced security
use_pkce = true

# TLS settings
tls_skip_verify_insecure = false
