# GitLab CI/CD Template: Docker Image Building
# Purpose: Build and push Docker images to GitLab Container Registry
# Usage: Include this template in your .gitlab-ci.yml:
#   include:
#     - local: '/ci-templates/docker-build.gitlab-ci.yml'

variables:
  # Docker image configuration
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Image naming - customize per project
  IMAGE_NAME: ${CI_REGISTRY_IMAGE}
  IMAGE_TAG: ${CI_COMMIT_SHORT_SHA}
  IMAGE_LATEST: ${CI_REGISTRY_IMAGE}:latest

# Stage definitions
stages:
  - build
  - test
  - push

# Docker build job
docker-build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
    - self-hosted
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building Docker image ${IMAGE_NAME}:${IMAGE_TAG}"
    - docker build
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        --build-arg VCS_REF=${CI_COMMIT_SHORT_SHA}
        --build-arg VERSION=${CI_COMMIT_TAG:-dev}
        --tag ${IMAGE_NAME}:${IMAGE_TAG}
        --file Dockerfile
        .
    - docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:build-${CI_PIPELINE_ID}
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
    - docker push ${IMAGE_NAME}:build-${CI_PIPELINE_ID}
  after_script:
    - docker logout $CI_REGISTRY
  only:
    - branches
    - tags
    - merge_requests

# Container image security scan (optional)
docker-scan:
  stage: test
  image: aquasec/trivy:latest
  tags:
    - docker
    - self-hosted
  script:
    - echo "Scanning image for vulnerabilities"
    - trivy image
        --severity HIGH,CRITICAL
        --no-progress
        --exit-code 0
        ${IMAGE_NAME}:${IMAGE_TAG}
  dependencies:
    - docker-build
  allow_failure: true
  only:
    - branches
    - tags

# Push to latest tag (main branch only)
docker-push-latest:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
    - self-hosted
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker pull ${IMAGE_NAME}:${IMAGE_TAG}
    - docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_LATEST}
    - docker push ${IMAGE_LATEST}
  after_script:
    - docker logout $CI_REGISTRY
  dependencies:
    - docker-build
  only:
    - main
    - master

# Push release tags (version tags only)
docker-push-release:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
    - self-hosted
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker pull ${IMAGE_NAME}:${IMAGE_TAG}
    - docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:${CI_COMMIT_TAG}
    - docker push ${IMAGE_NAME}:${CI_COMMIT_TAG}
    # Also push major.minor tag
    - export MAJOR_MINOR=$(echo ${CI_COMMIT_TAG} | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')
    - docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:${MAJOR_MINOR}
    - docker push ${IMAGE_NAME}:${MAJOR_MINOR}
  after_script:
    - docker logout $CI_REGISTRY
  dependencies:
    - docker-build
  only:
    - tags
  except:
    - branches

# Cleanup old build images (scheduled cleanup)
docker-cleanup:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
    - self-hosted
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Cleaning up old build images"
    - docker images | grep "build-" | awk '{print $3}' | xargs -r docker rmi -f || true
  after_script:
    - docker logout $CI_REGISTRY
  when: manual
  allow_failure: true
