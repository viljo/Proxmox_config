# GitLab CI/CD Template: Ansible Role Testing
# Purpose: Test Ansible roles with linting and syntax checks
# Usage: Include this template in your .gitlab-ci.yml:
#   include:
#     - local: '/ci-templates/ansible-role-test.gitlab-ci.yml'

variables:
  ANSIBLE_VERSION: "2.15"
  PYTHON_VERSION: "3.11"

stages:
  - lint
  - test
  - validate

# YAML linting
yaml-lint:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  before_script:
    - pip install yamllint
  script:
    - echo "Running YAML linter"
    - yamllint --version
    - yamllint .
  only:
    - branches
    - merge_requests
  allow_failure: false

# Ansible linting
ansible-lint:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  before_script:
    - pip install ansible==${ANSIBLE_VERSION}.* ansible-lint
  script:
    - echo "Running Ansible linter"
    - ansible-lint --version
    - ansible-lint --show-relpath
        --parseable
        --progressive
        roles/
        playbooks/
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    when: always
    expire_in: 1 week
  only:
    - branches
    - merge_requests
  allow_failure: true

# Ansible syntax check
ansible-syntax-check:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  before_script:
    - pip install ansible==${ANSIBLE_VERSION}.*
    - ansible --version
  script:
    - echo "Checking Ansible playbook syntax"
    - |
      for playbook in playbooks/*.yml; do
        echo "Checking $playbook"
        ansible-playbook --syntax-check "$playbook"
      done
  only:
    - branches
    - merge_requests
  allow_failure: false

# Role-specific syntax validation
role-syntax-check:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  before_script:
    - pip install ansible==${ANSIBLE_VERSION}.*
  script:
    - echo "Validating Ansible role structure"
    - |
      for role_dir in roles/*/; do
        role_name=$(basename "$role_dir")
        echo "Checking role: $role_name"

        # Check required directories
        for dir in tasks defaults handlers; do
          if [ ! -d "$role_dir/$dir" ]; then
            echo "WARNING: Missing $dir directory in $role_name"
          fi
        done

        # Check main.yml exists in tasks
        if [ ! -f "$role_dir/tasks/main.yml" ]; then
          echo "ERROR: Missing tasks/main.yml in $role_name"
          exit 1
        fi

        # Syntax check role tasks
        ansible-playbook --syntax-check \
          <(echo "---
          - hosts: localhost
            roles:
              - $role_name")
      done
  only:
    - branches
    - merge_requests
  allow_failure: false

# Molecule tests (if implemented)
molecule-test:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  before_script:
    - apt-get update && apt-get install -y docker.io
    - pip install ansible==${ANSIBLE_VERSION}.* molecule molecule-docker
  script:
    - echo "Running Molecule tests"
    - |
      for role_dir in roles/*/; do
        if [ -d "$role_dir/molecule" ]; then
          role_name=$(basename "$role_dir")
          echo "Testing role: $role_name"
          cd "$role_dir"
          molecule test
          cd -
        fi
      done
  services:
    - docker:24-dind
  only:
    - branches
    - merge_requests
  allow_failure: true

# Ansible Galaxy metadata validation
galaxy-lint:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  before_script:
    - pip install ansible==${ANSIBLE_VERSION}.*
  script:
    - echo "Validating Ansible Galaxy metadata"
    - |
      for role_dir in roles/*/; do
        if [ -f "$role_dir/meta/main.yml" ]; then
          role_name=$(basename "$role_dir")
          echo "Validating Galaxy metadata for: $role_name"
          ansible-galaxy role info --offline "$role_name" || true
        fi
      done
  only:
    - branches
    - merge_requests
  allow_failure: true

# Security check for secrets exposure
secrets-check:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  script:
    - echo "Checking for exposed secrets"
    - |
      # Check for potential vault passwords in plaintext
      if grep -r "vault_.*password.*:" . --include="*.yml" | grep -v "{{ vault_" | grep -v "#"; then
        echo "ERROR: Potential plaintext vault password found"
        exit 1
      fi

      # Check for hardcoded IPs or credentials
      if grep -rE "(password|secret|token):\s*['\"]?[a-zA-Z0-9]{8,}" . --include="*.yml" | grep -v "vault_" | grep -v "{{"; then
        echo "WARNING: Potential hardcoded credentials found"
      fi

      echo "No obvious secrets exposure detected"
  only:
    - branches
    - merge_requests
  allow_failure: false

# Generate role documentation
generate-docs:
  stage: validate
  image: python:${PYTHON_VERSION}-slim
  tags:
    - docker
    - self-hosted
  before_script:
    - pip install ansible==${ANSIBLE_VERSION}.* ansible-doc-extractor
  script:
    - echo "Generating role documentation"
    - |
      for role_dir in roles/*/; do
        role_name=$(basename "$role_dir")
        echo "Generating docs for: $role_name"
        ansible-doc -t role "$role_name" > "docs/${role_name}.md" || true
      done
  artifacts:
    paths:
      - docs/
    expire_in: 30 days
  only:
    - main
    - master
  allow_failure: true
