# Ansible Role Interface Contract
# Purpose: Define the public interface for the webtop Ansible role
# Version: 1.0.0
# Date: 2025-10-20

---
# Role Metadata

role_name: webtop
description: "Deploy LinuxServer.io Webtop in LXC container with Docker and Traefik integration"
author: "Infrastructure Team"
min_ansible_version: "2.15"
platforms:
  - name: "Proxmox VE"
    versions:
      - "8.0"
      - "8.1"
      - "8.2"

dependencies:
  - role: docker
    description: "Install Docker in LXC container"
  - role: traefik
    description: "Configure Traefik reverse proxy routing"
    optional: true

---
# Public Variables (defaults/main.yml)

variables:
  # LXC Container Configuration
  webtop_container_id:
    description: "Proxmox CT ID for webtop container"
    type: integer
    required: true
    default: 2400
    example: 2400

  webtop_hostname:
    description: "Container hostname"
    type: string
    required: true
    default: "webtop"
    example: "webtop"

  webtop_domain:
    description: "Fully qualified domain name"
    type: string
    required: true
    default: "browser.viljo.se"
    example: "browser.viljo.se"

  # Network Configuration
  webtop_ip_address:
    description: "Static IP address on DMZ network"
    type: string
    required: true
    default: "172.16.10.70"
    example: "172.16.10.70"

  webtop_netmask:
    description: "Network subnet mask"
    type: integer
    required: true
    default: 24
    example: 24

  webtop_gateway:
    description: "Default gateway IP"
    type: string
    required: true
    default: "172.16.10.1"
    example: "172.16.10.1"

  webtop_bridge:
    description: "Proxmox network bridge"
    type: string
    required: true
    default: "vmbr3"
    example: "vmbr3"

  # Resource Allocation
  webtop_memory_mb:
    description: "RAM allocation in MB"
    type: integer
    required: true
    default: 4096
    min: 2048
    example: 4096

  webtop_cpu_cores:
    description: "CPU core count"
    type: integer
    required: true
    default: 2
    min: 1
    example: 2

  webtop_disk_gb:
    description: "Root disk size in GB"
    type: integer
    required: true
    default: 20
    min: 10
    example: 20

  webtop_swap_mb:
    description: "Swap allocation in MB"
    type: integer
    required: true
    default: 2048
    example: 2048

  webtop_storage_pool:
    description: "Proxmox storage backend"
    type: string
    required: true
    default: "local-zfs"
    example: "local-zfs"

  # LXC Features
  webtop_unprivileged:
    description: "Run as unprivileged container"
    type: boolean
    required: true
    default: true
    immutable: true  # Constitutional requirement

  webtop_nesting:
    description: "Enable container nesting for Docker"
    type: boolean
    required: true
    default: true

  webtop_fuse:
    description: "Enable FUSE support"
    type: boolean
    required: true
    default: true

  webtop_onboot:
    description: "Auto-start container on host boot"
    type: boolean
    required: true
    default: true

  # Docker Configuration
  webtop_docker_image:
    description: "Webtop Docker image reference"
    type: string
    required: true
    default: "lscr.io/linuxserver/webtop:debian-xfce"
    example: "lscr.io/linuxserver/webtop:debian-xfce"

  webtop_web_port:
    description: "KasmVNC web interface port"
    type: integer
    required: true
    default: 3000
    example: 3000

  # Authentication Configuration
  webtop_auth_mode:
    description: "Authentication method"
    type: string
    required: true
    default: "builtin"
    choices:
      - "builtin"
      - "ldap"
    example: "builtin"

  webtop_admin_user:
    description: "Built-in admin username"
    type: string
    required: false  # Only if webtop_auth_mode=builtin
    default: "admin"
    example: "admin"
    vault: true

  webtop_admin_password:
    description: "Built-in admin password"
    type: string
    required: false  # Only if webtop_auth_mode=builtin
    default: null
    example: "{{ vault_webtop_admin_password }}"
    vault: true
    security: "MUST be stored in Ansible Vault"

  # LDAP Configuration (Phase 2)
  webtop_ldap_uri:
    description: "LDAP server URI"
    type: string
    required: false  # Only if webtop_auth_mode=ldap
    default: null
    example: "ldap://ldap.infra.local:389"

  webtop_ldap_base_dn:
    description: "LDAP search base DN"
    type: string
    required: false
    default: null
    example: "dc=infra,dc=local"

  webtop_ldap_bind_dn:
    description: "LDAP bind DN for service account"
    type: string
    required: false
    default: null
    example: "cn=webtop,ou=services,dc=infra,dc=local"
    vault: true

  webtop_ldap_bind_password:
    description: "LDAP bind password"
    type: string
    required: false
    default: null
    example: "{{ vault_ldap_bind_password }}"
    vault: true
    security: "MUST be stored in Ansible Vault"

  webtop_ldap_user_filter:
    description: "LDAP user search filter"
    type: string
    required: false
    default: "(uid=%s)"
    example: "(uid=%s)"

  # Desktop Configuration
  webtop_timezone:
    description: "Desktop timezone"
    type: string
    required: true
    default: "Europe/Stockholm"
    example: "Europe/Stockholm"

  webtop_keyboard_layout:
    description: "Keyboard layout"
    type: string
    required: true
    default: "sv-se-qwerty"
    example: "sv-se-qwerty"

  webtop_title:
    description: "Browser tab title"
    type: string
    required: true
    default: "Webtop - browser.viljo.se"
    example: "Webtop - browser.viljo.se"

  # Integration Flags
  webtop_enable_traefik:
    description: "Configure Traefik routing"
    type: boolean
    required: true
    default: true

  webtop_enable_netbox:
    description: "Register in NetBox CMDB"
    type: boolean
    required: true
    default: true

  webtop_enable_monitoring:
    description: "Configure Zabbix monitoring"
    type: boolean
    required: true
    default: true

  webtop_enable_backup:
    description: "Configure PBS backups"
    type: boolean
    required: true
    default: true

---
# Role Tasks Interface

tasks:
  - name: "Verify prerequisites"
    description: "Check Proxmox host, network connectivity, storage availability"
    idempotent: true

  - name: "Create LXC container"
    description: "Create unprivileged LXC with specified resources"
    idempotent: true
    check_mode: "Dry-run supported - reports if container would be created"

  - name: "Configure container networking"
    description: "Set static IP, gateway, DNS for container"
    idempotent: true

  - name: "Install Docker in container"
    description: "Install Docker Engine and Docker Compose"
    idempotent: true

  - name: "Create persistent volumes"
    description: "Create /var/lib/webtop/{config,data,logs} directories"
    idempotent: true

  - name: "Deploy webtop Docker container"
    description: "Deploy webtop via docker-compose.yml with environment config"
    idempotent: true
    triggers:
      - "Restart webtop container if environment changes"
      - "Pull new image if version updated"

  - name: "Configure Traefik routing"
    description: "Apply Docker labels for Traefik auto-discovery"
    idempotent: true
    when: "webtop_enable_traefik == true"

  - name: "Register in NetBox"
    description: "Create NetBox device entry with IP, network, tags"
    idempotent: true
    when: "webtop_enable_netbox == true"

  - name: "Configure monitoring"
    description: "Add Zabbix host and apply Docker container template"
    idempotent: true
    when: "webtop_enable_monitoring == true"

  - name: "Configure backups"
    description: "Add container to PBS backup job"
    idempotent: true
    when: "webtop_enable_backup == true"

---
# Role Handlers

handlers:
  - name: "restart webtop"
    description: "Restart webtop Docker container"
    listen: "webtop config changed"

  - name: "reload docker"
    description: "Reload Docker daemon configuration"
    listen: "docker config changed"

---
# Role Tags

tags:
  - lxc: "LXC container creation tasks"
  - docker: "Docker installation and configuration"
  - webtop: "Webtop container deployment"
  - traefik: "Traefik integration tasks"
  - netbox: "NetBox registration tasks"
  - monitoring: "Zabbix configuration tasks"
  - backup: "PBS backup configuration tasks"

---
# Example Playbook Usage

example_playbook: |
  ---
  - name: Deploy webtop browser instance
    hosts: proxmox_hosts
    become: true

    roles:
      - role: webtop
        vars:
          webtop_container_id: 2400
          webtop_hostname: webtop
          webtop_domain: browser.viljo.se
          webtop_ip_address: 172.16.10.70
          webtop_auth_mode: builtin
          webtop_admin_user: admin
          webtop_admin_password: "{{ vault_webtop_admin_password }}"

---
# Expected Outcomes

outcomes:
  - "LXC container CT 2400 created and running on Proxmox host"
  - "Webtop Docker container running on port 3000"
  - "Accessible at https://browser.viljo.se with valid TLS certificate"
  - "User can authenticate and access XFCE desktop in browser"
  - "NetBox entry created with container details"
  - "Zabbix monitoring active for container health"
  - "PBS backup job includes webtop container"

---
# Validation Commands

validation:
  - command: "pct list | grep 2400"
    expected: "Container 2400 appears in Proxmox CT list"

  - command: "pct exec 2400 -- docker ps | grep webtop"
    expected: "Webtop container running inside LXC"

  - command: "curl -I https://browser.viljo.se"
    expected: "HTTP 200 OK with valid TLS certificate"

  - command: "ssh proxmox 'ls -ld /var/lib/webtop/*'"
    expected: "Persistent volume directories exist with correct permissions"

---
# Error Handling

error_scenarios:
  - error: "Container ID already exists"
    resolution: "Skip creation if container exists (idempotent check)"

  - error: "IP address conflict"
    resolution: "Fail with clear message - user must resolve conflict or choose different IP"

  - error: "Docker image pull fails"
    resolution: "Retry up to 3 times, then fail with network diagnostic output"

  - error: "Traefik route not discovered"
    resolution: "Verify Docker socket access, check Traefik logs, validate labels"

  - error: "Authentication fails after deployment"
    resolution: "Check environment variables, verify Vault decryption, inspect webtop logs"

---
# Constitutional Compliance

compliance:
  infrastructure_as_code: "All tasks defined in Ansible role - no manual steps"
  security_first: "Unprivileged LXC, Vault-encrypted secrets, HTTPS-only access"
  idempotent: "All tasks can be re-run safely without side effects"
  single_source_of_truth: "NetBox registration ensures CMDB accuracy"
  automated_operations: "Backup, monitoring, and TLS cert renewal fully automated"
