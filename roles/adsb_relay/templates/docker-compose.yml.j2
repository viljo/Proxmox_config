services:
  # API to SBS converter - fetches from ADS-B.fi API
  {{ adsb_api2sbs_container }}:
    image: {{ adsb_api2sbs_image }}
    container_name: {{ adsb_api2sbs_container }}
    restart: unless-stopped

    environment:
      - TZ=Europe/Stockholm
      # ADS-B.fi OpenData API
      - API_URL={{ adsb_api_url }}
      # Location: lat,lon,radius_nm (Piteå, 250NM)
      - LOCATIONS={{ adsb_api_locations }}
      # Send SBS data to readsb container
      - SBS_SERVER={{ adsb_readsb_container }}
      - SBS_PORT={{ adsb_sbs_port }}
      # Poll interval (0.95Hz = ~1.05 seconds)
      - POLL_INTERVAL={{ adsb_api_poll_interval }}
      # Stats every 60 seconds
      - STATS_INTERVAL=60

    tmpfs:
      - /tmp:size=32M

    networks:
      - adsb_internal

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

  # Readsb - receives SBS data, provides web UI and Beast TCP output
  {{ adsb_readsb_container }}:
    image: {{ adsb_readsb_image }}
    container_name: {{ adsb_readsb_container }}
    hostname: adsb-relay
    restart: unless-stopped
    depends_on:
      - {{ adsb_api2sbs_container }}

    environment:
      - TZ=Europe/Stockholm

      # No hardware - network only mode
      - READSB_DEVICE_TYPE=none

      # Network settings - receive SBS data from api2sbs
      - READSB_NET_ENABLE=true
      - READSB_NET_SBS_INPUT_PORT={{ adsb_sbs_port }}

      # Beast output for external clients
      - READSB_NET_BEAST_OUTPUT_PORT={{ adsb_beast_output_port }}

      # Location for range/statistics (Piteå, Sweden)
      - READSB_LAT={{ adsb_latitude }}
      - READSB_LON={{ adsb_longitude }}

      # Enable stats
      - READSB_STATS_RANGE=true

      # JSON output for web clients
      - READSB_NET_RAW_OUTPUT_PORT=30002
      - READSB_NET_SBS_OUTPUT_PORT=30003

      # Enable tar1090 web interface
      - TAR1090_ENABLE=true

    ports:
      # Beast TCP - exposed for external TCP clients via NAT
      - "{{ adsb_beast_output_port }}:{{ adsb_beast_output_port }}"
      # Web UI port - internal, routed via Traefik (container listens on 8080)
      - "{{ adsb_web_port }}:8080"

    tmpfs:
      - /run/readsb:size=64M
      - /var/log:size=32M

    labels:
      - "traefik.enable=true"

      # Main web UI router
      - "traefik.http.routers.adsb.rule=Host(`{{ adsb_subdomain }}.{{ public_domain }}`)"
      - "traefik.http.routers.adsb.entrypoints=websecure"
      - "traefik.http.routers.adsb.tls.certresolver=letsencrypt"
      - "traefik.http.routers.adsb.service=adsb"
      - "traefik.http.services.adsb.loadbalancer.server.port=8080"

      # Streaming support for data endpoints
      - "traefik.http.services.adsb.loadbalancer.responseforwarding.flushinterval=-1"

    networks:
      - traefik_public
      - adsb_internal

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

networks:
  traefik_public:
    external: true
  adsb_internal:
    driver: bridge
