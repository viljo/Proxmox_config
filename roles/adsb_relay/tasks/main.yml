---
# ADS-B Relay deployment tasks
# Architecture: api2sbs -> SBS data -> readsb -> Web UI + Beast TCP

- name: Create deployment directory
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- mkdir -p {{ adsb_relay_deploy_path }}
  changed_when: true

- name: Create docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /tmp/adsb-relay-compose.yml
    mode: '0644'

- name: Copy docker-compose.yml to LXC
  ansible.builtin.command: >
    pct push {{ adsb_relay_lxc_id }} /tmp/adsb-relay-compose.yml {{ adsb_relay_deploy_path }}/docker-compose.yml
  changed_when: true

- name: Pull api2sbs image
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- docker pull {{ adsb_api2sbs_image }}
  changed_when: false

- name: Pull readsb image
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- docker pull {{ adsb_readsb_image }}
  changed_when: false

- name: Stop existing containers if running
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- bash -c 'cd {{ adsb_relay_deploy_path }} && docker compose down 2>/dev/null || true'
  changed_when: true

- name: Remove old single-container setup if exists
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- bash -c 'docker rm -f adsb-relay 2>/dev/null || true'
  changed_when: false

- name: Start ADS-B relay containers
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- bash -c 'cd {{ adsb_relay_deploy_path }} && docker compose up -d'
  changed_when: true

- name: Wait for containers to start
  ansible.builtin.pause:
    seconds: 15

- name: Check api2sbs container status
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- docker ps --filter name={{ adsb_api2sbs_container }} --format "{% raw %}{{.Status}}{% endraw %}"
  register: api2sbs_status
  changed_when: false

- name: Check readsb container status
  ansible.builtin.command: >
    pct exec {{ adsb_relay_lxc_id }} -- docker ps --filter name={{ adsb_readsb_container }} --format "{% raw %}{{.Status}}{% endraw %}"
  register: readsb_status
  changed_when: false

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "ADS-B Relay (ADS-B.fi API) deployed"
      - "API2SBS container: {{ api2sbs_status.stdout }}"
      - "Readsb container: {{ readsb_status.stdout }}"
      - "Data source: ADS-B.fi OpenData API"
      - "Location: {{ adsb_latitude }}, {{ adsb_longitude }} (250NM radius)"
      - "Web UI: https://{{ adsb_subdomain }}.{{ public_domain }}"
      - "Beast TCP: {{ adsb_subdomain }}.{{ public_domain }}:{{ adsb_beast_output_port }}"
