---
- name: Ensure Jitsi template cache directory exists
  ansible.builtin.file:
    path: "{{ jitsi_template_file | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Download template for Jitsi container
  ansible.builtin.get_url:
    url: "{{ jitsi_template_url }}"
    dest: "{{ jitsi_template_file }}"
    mode: "0644"
    force: false
  when: not ansible_check_mode

- name: Compose Jitsi container network configuration
  ansible.builtin.set_fact:
    jitsi_net0: >-
      name=eth0,bridge={{ jitsi_bridge }}{% if jitsi_vlan_tag %},tag={{ jitsi_vlan_tag }}{% endif %},ip={{ jitsi_ip_config }}{% if jitsi_gateway is defined and jitsi_gateway %},gw={{ jitsi_gateway }}{% endif %}

- name: Ensure Jitsi container exists
  ansible.builtin.shell: |
    pct create {{ jitsi_container_id }} {{ jitsi_template_file }} \
      --hostname {{ jitsi_hostname }} \
      --cores {{ jitsi_cores }} \
      --memory {{ jitsi_memory }} \
      --swap {{ jitsi_swap }} \
      --rootfs {{ jitsi_rootfs_storage }}:{{ jitsi_disk }} \
      --net0 {{ jitsi_net0 }} \
      {% if jitsi_unprivileged %}--unprivileged 1{% endif %}
  args:
    creates: "/etc/pve/lxc/{{ jitsi_container_id }}.conf"
  when: not ansible_check_mode

- name: Stat Jitsi container configuration
  ansible.builtin.stat:
    path: "/etc/pve/lxc/{{ jitsi_container_id }}.conf"
  register: jitsi_container_conf

- name: Ensure Jitsi container network configuration
  ansible.builtin.command:
    cmd: >
      pct set {{ jitsi_container_id }} --net0 {{ jitsi_net0 }}
  when: not ansible_check_mode and jitsi_container_conf.stat.exists

- name: Ensure Jitsi container onboot flag is set
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ jitsi_container_id }}.conf"
    regexp: '^onboot:'
    line: "onboot: {{ 1 if jitsi_start_onboot else 0 }}"
    insertafter: EOF
  when: jitsi_container_conf.stat.exists

- name: Ensure Jitsi container features list is present
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ jitsi_container_id }}.conf"
    regexp: '^features:'
    line: "features: {{ jitsi_features | dictsort | map('join', '=') | join(';') }}"
    insertafter: EOF
  when: jitsi_container_conf.stat.exists and jitsi_features | length > 0

- name: Ensure Jitsi container DNS servers are set
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ jitsi_container_id }}.conf"
    regexp: '^nameserver:'
    line: "nameserver: {{ jitsi_dns_servers | join(' ') }}"
    insertafter: EOF
  when: jitsi_container_conf.stat.exists and jitsi_dns_servers is defined and jitsi_dns_servers | length > 0

- name: Ensure Jitsi recording storage directory exists on host
  ansible.builtin.file:
    path: "{{ jitsi_recording_storage_host }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: jitsi_enable_recording

- name: Ensure Jitsi recording storage bind mount is configured
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ jitsi_container_id }}.conf"
    regexp: '^mp0:'
    line: "mp0: {{ jitsi_recording_storage_host }},mp={{ jitsi_recording_storage_container }}"
    insertafter: EOF
  when: jitsi_container_conf.stat.exists and jitsi_enable_recording

- name: Read Jitsi container status
  ansible.builtin.command:
    cmd: pct status {{ jitsi_container_id }}
  register: jitsi_status
  changed_when: false
  failed_when: jitsi_status.rc not in [0, 2]
  when: jitsi_container_conf.stat.exists

- name: Start Jitsi container
  ansible.builtin.command:
    cmd: pct start {{ jitsi_container_id }}
  when:
    - not ansible_check_mode
    - jitsi_container_conf.stat.exists
    - jitsi_status.rc is defined
    - (jitsi_status.rc != 0 or ('stopped' in jitsi_status.stdout | default('')))

- name: Wait for Jitsi container to boot
  ansible.builtin.command:
    cmd: pct exec {{ jitsi_container_id }} -- bash -lc "true"
  register: jitsi_boot_probe
  failed_when: false
  changed_when: false
  retries: 10
  delay: 3
  until: jitsi_boot_probe.rc == 0
  when:
    - not ansible_check_mode
    - jitsi_container_conf.stat.exists

- name: Ensure Jitsi root password is set
  ansible.builtin.command:
    cmd: >
      pct exec {{ jitsi_container_id }} -- bash -lc "echo 'root:{{ jitsi_root_password }}' | chpasswd"
  no_log: true
  when:
    - not ansible_check_mode
    - jitsi_container_conf.stat.exists
    - jitsi_root_password is defined
    - jitsi_root_password | length > 0

- name: Check Jitsi provisioning marker
  ansible.builtin.command:
    cmd: >
      pct exec {{ jitsi_container_id }} -- bash -lc "test -f /etc/jitsi/.provisioned"
  register: jitsi_provision_marker
  changed_when: false
  failed_when: false
  when: jitsi_container_conf.stat.exists

- name: Install Docker engine
  ansible.builtin.command:
    cmd: >
      pct exec {{ jitsi_container_id }} -- bash -lc "apt-get update && apt-get install -y docker.io docker-compose-plugin"
  when:
    - not ansible_check_mode
    - jitsi_container_conf.stat.exists
    - jitsi_provision_marker.rc is defined
    - jitsi_provision_marker.rc != 0

- name: Ensure Docker service is enabled
  ansible.builtin.command:
    cmd: >
      pct exec {{ jitsi_container_id }} -- systemctl enable docker
  when:
    - not ansible_check_mode
    - jitsi_container_conf.stat.exists

- name: Ensure compose directory exists on host
  ansible.builtin.file:
    path: "{{ jitsi_rootfs_path }}{{ jitsi_compose_path }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy Jitsi docker compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ jitsi_rootfs_path }}{{ jitsi_compose_path }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"
  notify: restart jitsi stack

- name: Ensure Jitsi .env file directory exists
  ansible.builtin.file:
    path: "{{ jitsi_rootfs_path }}{{ jitsi_compose_path }}/.jitsi-meet-cfg"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy Jitsi environment configuration
  ansible.builtin.template:
    src: jitsi.env.j2
    dest: "{{ jitsi_rootfs_path }}{{ jitsi_compose_path }}/.env"
    owner: root
    group: root
    mode: "0600"
  notify: restart jitsi stack

- name: Create provisioning marker for Jitsi
  ansible.builtin.command:
    cmd: >
      pct exec {{ jitsi_container_id }} -- bash -lc "mkdir -p /etc/jitsi && touch /etc/jitsi/.provisioned"
  when:
    - not ansible_check_mode
    - jitsi_container_conf.stat.exists
    - jitsi_provision_marker.rc is defined
    - jitsi_provision_marker.rc != 0

- name: Ensure Jitsi recording directory exists in container
  ansible.builtin.command:
    cmd: >
      pct exec {{ jitsi_container_id }} -- bash -lc "mkdir -p {{ jitsi_recording_storage_container }} && chmod 755 {{ jitsi_recording_storage_container }}"
  when:
    - not ansible_check_mode
    - jitsi_container_conf.stat.exists
    - jitsi_enable_recording
