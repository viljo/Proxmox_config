#!/usr/bin/env python3
# Loopia DDNS Update Script
# Generated by Ansible - Do not edit manually
import json
import subprocess
import sys
from pathlib import Path
import xmlrpc.client

# Get IP from host interface (WAN)
INTERFACE = "{{ loopia_ddns_interface }}"
STATE_DIR = Path("{{ loopia_ddns_state_path }}")
STATE_DIR.mkdir(parents=True, exist_ok=True)
LAST_IP_FILE = STATE_DIR / "last_ip"
RECORDS_FILE = STATE_DIR / "records.json"

DOMAIN = "{{ public_domain }}"
USER = "{{ loopia_api_user }}"
PASSWORD = "{{ loopia_api_password }}"

if not USER or not PASSWORD:
    sys.exit("Loopia credentials are missing")

try:
    ip_output = subprocess.check_output([
        "ip", "-4", "-o", "addr", "show", "dev", INTERFACE, "scope", "global"
    ], text=True).strip()
except subprocess.CalledProcessError:
    print(f"Error: Could not get IP from interface {INTERFACE}")
    sys.exit(1)

if not ip_output:
    print(f"Error: No IP address on interface {INTERFACE}")
    sys.exit(1)

try:
    current_ip = ip_output.split()[3].split("/")[0]
except IndexError:
    print(f"Error: Could not parse IP from: {ip_output}")
    sys.exit(1)

print(f"Current WAN IP: {current_ip}")

previous_ip = LAST_IP_FILE.read_text().strip() if LAST_IP_FILE.exists() else None

if previous_ip == current_ip and RECORDS_FILE.exists():
    records = json.loads(RECORDS_FILE.read_text())
    print(f"IP unchanged from {previous_ip}, checking records...")
else:
    records = [
{% for record in loopia_ddns_records %}
        {"host": "{{ record.host }}"{% if record.ttl is defined %}, "ttl": {{ record.ttl }}{% endif %}},
{% endfor %}
    ]
    print(f"IP changed from {previous_ip} to {current_ip}, updating all records...")

client = xmlrpc.client.ServerProxy("https://api.loopia.se/RPCSERV", allow_none=True)
updated = False

for record in records:
    host = record.get("host")
    record_type = record.get("type", "A")
    ttl = int(record.get("ttl", 600))
    rdata = current_ip if record.get("rdata") is None else record.get("rdata")

    if rdata != current_ip and record.get("rdata") is not None:
        continue

    try:
        records_existing = client.getZoneRecords(USER, PASSWORD, DOMAIN, host)
    except Exception as e:
        print(f"Error getting records for {host}: {e}")
        continue

    target = next((item for item in records_existing if item.get("type") == record_type), None)

    if target and target.get("rdata") == current_ip and int(target.get("ttl", ttl)) == ttl:
        print(f"  {host}.{DOMAIN} already points to {current_ip}")
        continue

    try:
        if target:
            client.removeZoneRecord(USER, PASSWORD, DOMAIN, host, target["record_id"])
            priority = target.get("priority", 0)
            print(f"  Removed old record for {host}.{DOMAIN}")
        else:
            priority = 0
        client.addZoneRecord(USER, PASSWORD, DOMAIN, host, {
            "type": record_type,
            "ttl": ttl,
            "priority": priority,
            "rdata": current_ip,
        })
        print(f"  Updated {host}.{DOMAIN} -> {current_ip}")
        updated = True
    except Exception as e:
        print(f"  Error updating {host}: {e}")
        continue

if updated or previous_ip != current_ip:
    LAST_IP_FILE.write_text(current_ip + "\n")
    RECORDS_FILE.write_text(json.dumps(records))
    print("State saved.")

print("DDNS update complete.")
