---
- name: Create deployment directory
  ansible.builtin.shell: |
    pct exec {{ adsb_nats_relay_lxc_id }} -- mkdir -p {{ adsb_nats_relay_deploy_path }}/adsb-nats-relay/src
  changed_when: false

- name: Copy source code to server
  ansible.builtin.shell: |
    tar -C /Users/anders/git/adsb-nats-relay -czf - src pyproject.toml Dockerfile | \
      ssh -p 22 root@ssh.viljo.se "pct exec {{ adsb_nats_relay_lxc_id }} -- tar -C {{ adsb_nats_relay_deploy_path }}/adsb-nats-relay -xzf -"
  changed_when: false
  delegate_to: localhost

- name: Deploy docker-compose.yml
  ansible.builtin.shell: |
    cat << 'EOF' | pct exec {{ adsb_nats_relay_lxc_id }} -- tee {{ adsb_nats_relay_deploy_path }}/docker-compose.yml
    {{ lookup('template', 'docker-compose.yml.j2') }}
    EOF
  changed_when: false

- name: Build and start services
  ansible.builtin.shell: |
    pct exec {{ adsb_nats_relay_lxc_id }} -- docker compose -f {{ adsb_nats_relay_deploy_path }}/docker-compose.yml up -d --build
  changed_when: false

- name: Wait for NATS to be running
  ansible.builtin.shell: |
    pct exec {{ adsb_nats_relay_lxc_id }} -- docker compose -f {{ adsb_nats_relay_deploy_path }}/docker-compose.yml ps --format json | grep -q '"State":"running"'
  register: running_check
  retries: 30
  delay: 2
  until: running_check.rc == 0
  changed_when: false

- name: Verify NATS relay is running
  ansible.builtin.shell: |
    pct exec {{ adsb_nats_relay_lxc_id }} -- docker logs {{ nats_relay_container }} 2>&1 | tail -10
  register: relay_logs
  changed_when: false

- name: Display relay status
  ansible.builtin.debug:
    msg: "{{ relay_logs.stdout_lines }}"
