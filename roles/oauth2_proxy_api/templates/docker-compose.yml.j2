services:
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:{{ oauth2_proxy_version }}
    container_name: oauth2-proxy
    restart: unless-stopped
    ports:
      - "{{ oauth2_proxy_service_port }}:4180"  # Expose on all interfaces for Traefik access from DMZ network
    environment:
      # Provider configuration
      OAUTH2_PROXY_PROVIDER: "{{ oauth2_proxy_provider }}"
      OAUTH2_PROXY_CLIENT_ID: "{{ oauth2_proxy_client_id }}"
      OAUTH2_PROXY_CLIENT_SECRET: "{{ oauth2_proxy_client_secret }}"
      OAUTH2_PROXY_COOKIE_SECRET: "{{ oauth2_proxy_cookie_secret }}"

      # OIDC Configuration
      OAUTH2_PROXY_OIDC_ISSUER_URL: "{{ oauth2_proxy_oidc_issuer_url }}"
      OAUTH2_PROXY_REDIRECT_URL: "{{ oauth2_proxy_redirect_url }}"
      OAUTH2_PROXY_LOGIN_URL: "{{ oauth2_proxy_login_url }}"
      OAUTH2_PROXY_REDEEM_URL: "{{ oauth2_proxy_redeem_url }}"
      OAUTH2_PROXY_PROFILE_URL: "{{ oauth2_proxy_profile_url }}"
      OAUTH2_PROXY_VALIDATE_URL: "{{ oauth2_proxy_validate_url }}"
      OAUTH2_PROXY_SCOPE: "{{ oauth2_proxy_scope }}"
      OAUTH2_PROXY_SKIP_OIDC_DISCOVERY: "{{ oauth2_proxy_skip_oidc_discovery | lower }}"
      OAUTH2_PROXY_OIDC_JWKS_URL: "{{ oauth2_proxy_jwks_url }}"

      # Cookie configuration
      OAUTH2_PROXY_COOKIE_DOMAINS: "{{ oauth2_proxy_cookie_domain }}"
      OAUTH2_PROXY_COOKIE_SECURE: "{{ oauth2_proxy_cookie_secure | lower }}"
      OAUTH2_PROXY_COOKIE_HTTPONLY: "{{ oauth2_proxy_cookie_httponly | lower }}"
      OAUTH2_PROXY_COOKIE_SAMESITE: "{{ oauth2_proxy_cookie_samesite }}"
      OAUTH2_PROXY_COOKIE_EXPIRE: "{{ oauth2_proxy_cookie_expire }}"
      OAUTH2_PROXY_COOKIE_REFRESH: "{{ oauth2_proxy_cookie_refresh }}"
      OAUTH2_PROXY_SESSION_STORE_TYPE: "{{ oauth2_proxy_session_store_type }}"

      # Email/domain configuration
      OAUTH2_PROXY_EMAIL_DOMAINS: "{{ oauth2_proxy_email_domains }}"
      OAUTH2_PROXY_WHITELIST_DOMAINS: "{{ oauth2_proxy_whitelist_domains }}"

      # Upstream configuration (dummy for forward auth mode)
      OAUTH2_PROXY_UPSTREAMS: "{{ oauth2_proxy_upstreams }}"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"

      # Header configuration
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "{{ oauth2_proxy_pass_authorization_header | lower }}"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "{{ oauth2_proxy_pass_access_token | lower }}"
      OAUTH2_PROXY_PASS_USER_HEADERS: "{{ oauth2_proxy_pass_user_headers | lower }}"
      OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "{{ oauth2_proxy_set_authorization_header | lower }}"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "{{ oauth2_proxy_set_xauthrequest | lower }}"

      # Logging
      OAUTH2_PROXY_REQUEST_LOGGING: "{{ oauth2_proxy_request_logging | lower }}"
      OAUTH2_PROXY_AUTH_LOGGING: "{{ oauth2_proxy_auth_logging | lower }}"
      OAUTH2_PROXY_STANDARD_LOGGING: "{{ oauth2_proxy_standard_logging | lower }}"

      # OIDC specific
      OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL: "{{ oauth2_proxy_insecure_oidc_allow_unverified_email | lower }}"
      OAUTH2_PROXY_OIDC_GROUPS_CLAIM: "{{ oauth2_proxy_oidc_groups_claim }}"

      # Reverse proxy settings
      OAUTH2_PROXY_REVERSE_PROXY: "{{ oauth2_proxy_reverse_proxy | lower }}"
      OAUTH2_PROXY_REAL_CLIENT_IP_HEADER: "{{ oauth2_proxy_real_client_ip_header }}"

      # UI settings
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "{{ oauth2_proxy_skip_provider_button | lower }}"

      # Timezone
      TZ: "Europe/Stockholm"
    networks:
      - traefik
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4180/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  traefik:
    external: true
