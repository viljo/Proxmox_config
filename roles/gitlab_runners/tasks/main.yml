---
# GitLab Runners deployment tasks

- name: Create runner directory
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- mkdir -p {{ gitlab_runner_base_path }}/config
  changed_when: true

- name: Create docker-compose.yml on Proxmox host
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /tmp/gitlab-runners-docker-compose.yml
    mode: '0644'

- name: Copy docker-compose.yml to LXC
  ansible.builtin.command: >
    pct push {{ lxc_id }} /tmp/gitlab-runners-docker-compose.yml {{ gitlab_runner_base_path }}/docker-compose.yml
  changed_when: true

- name: Stop existing runner containers
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- bash -c 'cd {{ gitlab_runner_base_path }} && docker compose down 2>/dev/null || true'
  changed_when: true

- name: Start runner container
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- bash -c 'cd {{ gitlab_runner_base_path }} && docker compose up -d'
  changed_when: true

- name: Wait for runner to be running
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- docker ps --filter name=gitlab-runner --format '{% raw %}{{.Names}} {{.Status}}{% endraw %}'
  register: runner_status
  until: "'Up' in runner_status.stdout"
  retries: 6
  delay: 5

- name: Verify runner
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- docker exec gitlab-runner gitlab-runner verify 2>&1
  register: runner_verify
  changed_when: false
  ignore_errors: true

- name: Display runner status
  ansible.builtin.debug:
    msg: |
      GitLab Runner deployed.

      Configuration:
      - Name: {{ gitlab_runner_name }}
      - Concurrent jobs: {{ gitlab_runner_concurrent }}
      - Image pull policy: {{ gitlab_runner_docker_pull_policy }}
      - Target: gitlab.com

      Verify with:
        pct exec 200 -- docker exec gitlab-runner gitlab-runner list
