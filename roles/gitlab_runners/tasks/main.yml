---
# GitLab Runners deployment tasks

- name: Create runner directories
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- mkdir -p {{ item }}
  loop:
    - "{{ gitlab_runner_base_path }}"
    - "{{ gitlab_runner_base_path }}/runner-1/config"
    - "{{ gitlab_runner_base_path }}/runner-2/config"
  changed_when: true

- name: Get Traefik container IP
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- docker inspect traefik --format '{% raw %}{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}{% endraw %}'
  register: traefik_ip_result
  changed_when: false

- name: Set Traefik IP fact
  ansible.builtin.set_fact:
    traefik_container_ip: "{{ traefik_ip_result.stdout }}"

- name: Create docker-compose.yml on Proxmox host
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /tmp/gitlab-runners-docker-compose.yml
    mode: '0644'

- name: Copy docker-compose.yml to LXC
  ansible.builtin.command: >
    pct push {{ lxc_id }} /tmp/gitlab-runners-docker-compose.yml {{ gitlab_runner_base_path }}/docker-compose.yml
  changed_when: true

- name: Stop existing runner containers
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- bash -c 'cd {{ gitlab_runner_base_path }} && docker compose down 2>/dev/null || true'
  changed_when: true

- name: Start runner containers
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- bash -c 'cd {{ gitlab_runner_base_path }} && docker compose up -d'
  changed_when: true

- name: Wait for runners to be running
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- docker ps --filter name=gitlab-runner --format '{% raw %}{{.Names}} {{.Status}}{% endraw %}'
  register: runner_status
  until: "'Up' in runner_status.stdout"
  retries: 6
  delay: 5

- name: Verify runners can reach local GitLab
  ansible.builtin.command: >
    pct exec {{ lxc_id }} -- docker exec gitlab-runner-1 gitlab-runner verify 2>&1
  register: runner_verify
  changed_when: false
  ignore_errors: true

- name: Display runner status
  ansible.builtin.debug:
    msg: |
      GitLab Runners deployed with persistent configuration.

      Runners are configured to serve:
      - gitlab.com (existing projects)
      - gitlab.viljo.se (local GitLab)

      DNS Resolution:
      - gitlab.viljo.se -> {{ traefik_container_ip }} (Traefik)

      Verify with:
        pct exec 200 -- docker exec gitlab-runner-1 gitlab-runner list
