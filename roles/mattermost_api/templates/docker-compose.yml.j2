services:
  mattermost:
    image: mattermost/mattermost-team-edition:{{ mattermost_version }}
    container_name: mattermost
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    pids_limit: 200
    tmpfs:
      - /tmp
    ports:
      - "{{ mattermost_service_port }}:8065"
    environment:
      # PostgreSQL settings
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: "postgres://{{ mattermost_db_user }}:{{ mattermost_db_password }}@{{ mattermost_db_host }}:{{ mattermost_db_port }}/{{ mattermost_db_name }}?sslmode=disable&connect_timeout=10"

      # Cluster settings (disabled for single-node)
      MM_CLUSTERSETTINGS_ENABLE: "false"
      MM_CLUSTERSETTINGS_READONLYCONFIG: "false"

      # Site URL
      MM_SERVICESETTINGS_SITEURL: "{{ mattermost_site_url }}"
      MM_SERVICESETTINGS_LISTENADDRESS: ":8065"

      # Performance
      MM_SQLSETTINGS_MAXIDLECONNS: 20
      MM_SQLSETTINGS_MAXOPENCONNS: 300

      # Timezone
      TZ: "{{ mattermost_timezone }}"

      # Keycloak OIDC Authentication (via GitLab OAuth settings)
{% if mattermost_oidc_enabled | default(false) %}
      MM_GITLABSETTINGS_ENABLE: "true"
      MM_GITLABSETTINGS_ID: "{{ mattermost_oidc_client_id }}"
      MM_GITLABSETTINGS_SECRET: "{{ mattermost_oidc_client_secret }}"
      MM_GITLABSETTINGS_SCOPE: "openid profile email"
      MM_GITLABSETTINGS_AUTHENDPOINT: "{{ mattermost_oidc_auth_endpoint }}"
      MM_GITLABSETTINGS_TOKENENDPOINT: "{{ mattermost_oidc_token_endpoint }}"
      MM_GITLABSETTINGS_USERAPIENDPOINT: "{{ mattermost_oidc_userinfo_endpoint }}"
{% endif %}
    volumes:
      - {{ mattermost_data_dir }}/config:/mattermost/config:rw
      - {{ mattermost_data_dir }}/data:/mattermost/data:rw
      - {{ mattermost_data_dir }}/logs:/mattermost/logs:rw
      - {{ mattermost_data_dir }}/plugins:/mattermost/plugins:rw
      - {{ mattermost_data_dir }}/client-plugins:/mattermost/client/plugins:rw
