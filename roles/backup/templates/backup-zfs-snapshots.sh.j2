#!/bin/bash
# ZFS Snapshot Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

SNAPSHOT_TYPE="${1:-hourly}"
DATE=$(date +%Y%m%d_%H%M%S)
LOG_PREFIX="[ZFS Snapshot]"

echo "$LOG_PREFIX Starting $SNAPSHOT_TYPE snapshot at $(date)"

{% for dataset in zfs_datasets %}
# Snapshot {{ dataset }}
SNAPSHOT_NAME="{{ dataset }}@${SNAPSHOT_TYPE}_${DATE}"
echo "$LOG_PREFIX Creating snapshot: $SNAPSHOT_NAME"

if zfs snapshot "$SNAPSHOT_NAME"; then
    echo "$LOG_PREFIX ✅ Snapshot created: $SNAPSHOT_NAME"
else
    echo "$LOG_PREFIX ❌ Failed to create snapshot: $SNAPSHOT_NAME"
fi

{% endfor %}

# Cleanup old snapshots based on type
echo "$LOG_PREFIX Cleaning up old $SNAPSHOT_TYPE snapshots..."

{% for dataset in zfs_datasets %}
case "$SNAPSHOT_TYPE" in
    hourly)
        KEEP={{ zfs_snapshot_hourly_keep }}
        ;;
    daily)
        KEEP={{ zfs_snapshot_daily_keep }}
        ;;
    weekly)
        KEEP={{ zfs_snapshot_weekly_keep }}
        ;;
    *)
        KEEP=7
        ;;
esac

# List snapshots for this dataset and type, delete old ones
SNAPSHOTS=$(zfs list -t snapshot -o name -s creation | grep "^{{ dataset }}@${SNAPSHOT_TYPE}_" | head -n -$KEEP 2>/dev/null || true)

if [ -n "$SNAPSHOTS" ]; then
    echo "$SNAPSHOTS" | while read SNAP; do
        echo "$LOG_PREFIX Removing old snapshot: $SNAP"
        zfs destroy "$SNAP" || echo "$LOG_PREFIX ⚠️  Failed to destroy: $SNAP"
    done
else
    echo "$LOG_PREFIX No old snapshots to remove for {{ dataset }}"
fi

{% endfor %}

echo "$LOG_PREFIX Snapshot process completed at $(date)"

# List current snapshots
echo "$LOG_PREFIX Current snapshots:"
zfs list -t snapshot -o name,creation,used | grep -E "{% for dataset in zfs_datasets %}{{ dataset }}{% if not loop.last %}|{% endif %}{% endfor %}" | tail -20 || echo "No snapshots found"
