#!/bin/bash
# PostgreSQL Backup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BACKUP_DIR="{{ backup_base_path }}/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
CONTAINER_ID="{{ backup_container_id }}"
LOG_PREFIX="[PostgreSQL Backup]"

echo "$LOG_PREFIX Starting backup at $(date)"

{% for db in postgres_databases %}
# Backup {{ db.name }} database
echo "$LOG_PREFIX Backing up {{ db.name }}..."
BACKUP_FILE="${BACKUP_DIR}/{{ db.name }}_${DATE}.sql.gz"

if pct exec $CONTAINER_ID -- docker exec {{ db.container }} pg_dump -U {{ db.user }} {{ db.name }} 2>/dev/null | gzip > "$BACKUP_FILE"; then
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo "$LOG_PREFIX ✅ {{ db.name }} backup complete: $BACKUP_FILE ($SIZE)"
else
    echo "$LOG_PREFIX ❌ {{ db.name }} backup FAILED"
    rm -f "$BACKUP_FILE"
fi

{% endfor %}

# Create latest symlinks
echo "$LOG_PREFIX Creating latest symlinks..."
{% for db in postgres_databases %}
LATEST_{{ db.name | upper }}=$(ls -t ${BACKUP_DIR}/{{ db.name }}_*.sql.gz 2>/dev/null | head -1)
if [ -n "$LATEST_{{ db.name | upper }}" ]; then
    ln -sf "$LATEST_{{ db.name | upper }}" "${BACKUP_DIR}/{{ db.name }}_latest.sql.gz"
fi
{% endfor %}

echo "$LOG_PREFIX Backup completed at $(date)"
echo "$LOG_PREFIX Backup directory contents:"
ls -lh "$BACKUP_DIR"/*.sql.gz 2>/dev/null | tail -10 || echo "No backups found"
