#!/bin/bash
# Backup Cleanup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BACKUP_DIR="{{ backup_base_path }}"
LOG_PREFIX="[Backup Cleanup]"
RETENTION_DAYS={{ backup_retention_days }}

echo "$LOG_PREFIX Starting cleanup at $(date)"
echo "$LOG_PREFIX Retention policy: $RETENTION_DAYS days"

# Cleanup PostgreSQL backups
echo "$LOG_PREFIX Cleaning up PostgreSQL backups older than $RETENTION_DAYS days..."
DELETED_PG=$(find "${BACKUP_DIR}/postgres" -name "*.sql.gz" -type f -mtime +$RETENTION_DAYS -delete -print 2>/dev/null | wc -l)
echo "$LOG_PREFIX Removed $DELETED_PG old PostgreSQL backup(s)"

# Cleanup Docker config backups
echo "$LOG_PREFIX Cleaning up Docker config backups older than $RETENTION_DAYS days..."
DELETED_DOCKER=$(find "${BACKUP_DIR}/docker-configs" -name "*.tar.gz" -type f -mtime +$RETENTION_DAYS -delete -print 2>/dev/null | wc -l)
echo "$LOG_PREFIX Removed $DELETED_DOCKER old Docker config backup(s)"

# Report disk usage
echo "$LOG_PREFIX Backup storage usage:"
du -sh "${BACKUP_DIR}"/* 2>/dev/null || echo "Unable to determine storage usage"

echo ""
echo "$LOG_PREFIX Total backup storage:"
du -sh "${BACKUP_DIR}" 2>/dev/null || echo "Unable to determine total storage"

# Count remaining backups
echo ""
echo "$LOG_PREFIX Backup inventory:"
echo "  PostgreSQL backups: $(find ${BACKUP_DIR}/postgres -name '*.sql.gz' -type f 2>/dev/null | wc -l)"
echo "  Docker config backups: $(find ${BACKUP_DIR}/docker-configs -name '*.tar.gz' -type f 2>/dev/null | wc -l)"
echo "  ZFS snapshots: $(zfs list -t snapshot 2>/dev/null | grep -E "{% for dataset in zfs_datasets %}{{ dataset }}{% if not loop.last %}|{% endif %}{% endfor %}" | wc -l)"

echo ""
echo "$LOG_PREFIX Cleanup completed at $(date)"
