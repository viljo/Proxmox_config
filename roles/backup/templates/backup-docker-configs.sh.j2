#!/bin/bash
# Docker Configs Backup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BACKUP_DIR="{{ backup_base_path }}/docker-configs"
DATE=$(date +%Y%m%d_%H%M%S)
CONTAINER_ID="{{ backup_container_id }}"
STACK_PATH="{{ docker_stack_path }}"
LOG_PREFIX="[Docker Configs Backup]"

echo "$LOG_PREFIX Starting backup at $(date)"

{% for service in docker_services %}
# Backup {{ service.name }} config
echo "$LOG_PREFIX Backing up {{ service.name }}..."
BACKUP_FILE="${BACKUP_DIR}/{{ service.name }}_${DATE}.tar.gz"

if pct exec $CONTAINER_ID -- tar czf - -C "${STACK_PATH}" "{{ service.name }}" 2>/dev/null > "$BACKUP_FILE"; then
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo "$LOG_PREFIX ✅ {{ service.name }} backup complete: $BACKUP_FILE ($SIZE)"
else
    echo "$LOG_PREFIX ⚠️  {{ service.name }} backup skipped (directory may not exist)"
    rm -f "$BACKUP_FILE"
fi

{% endfor %}

# Create latest symlinks
echo "$LOG_PREFIX Creating latest symlinks..."
{% for service in docker_services %}
LATEST_{{ service.name | upper | replace('-', '_') }}=$(ls -t ${BACKUP_DIR}/{{ service.name }}_*.tar.gz 2>/dev/null | head -1)
if [ -n "$LATEST_{{ service.name | upper | replace('-', '_') }}" ]; then
    ln -sf "$LATEST_{{ service.name | upper | replace('-', '_') }}" "${BACKUP_DIR}/{{ service.name }}_latest.tar.gz"
fi
{% endfor %}

echo "$LOG_PREFIX Backup completed at $(date)"
echo "$LOG_PREFIX Backup directory contents:"
ls -lh "$BACKUP_DIR"/*.tar.gz 2>/dev/null | tail -20 || echo "No backups found"
