---
version: "3.9"

services:
  wazuh-indexer:
    image: wazuh/wazuh-indexer:{{ wazuh_version }}
    container_name: wazuh-indexer
    hostname: wazuh-indexer
    restart: unless-stopped
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms2g -Xmx2g"
      - "bootstrap.memory_lock=true"
      - "discovery.type=single-node"
      - "network.host=0.0.0.0"
      - "INDEXER_PASSWORD={{ wazuh_indexer_password }}"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
    volumes:
      - wazuh_indexer_data:/var/lib/wazuh-indexer
      - ./config/wazuh_indexer_ssl_certs:/usr/share/wazuh-indexer/certs
    networks:
      - wazuh_network
    healthcheck:
      test: ["CMD-SHELL", "curl -sku admin:admin https://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  wazuh-manager:
    image: wazuh/wazuh-manager:{{ wazuh_version }}
    container_name: wazuh-manager
    hostname: wazuh-manager
    restart: unless-stopped
    environment:
      - "INDEXER_URL=https://wazuh-indexer:9200"
      - "INDEXER_USERNAME=admin"
      - "INDEXER_PASSWORD={{ wazuh_indexer_password }}"
      - "FILEBEAT_SSL_VERIFICATION_MODE=none"
      - "SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem"
      - "SSL_CERTIFICATE=/etc/ssl/filebeat.pem"
      - "SSL_KEY=/etc/ssl/filebeat.key"
      - "API_USERNAME={{ wazuh_api_user }}"
      - "API_PASSWORD={{ wazuh_api_password }}"
    ports:
      - "1514:1514"     # Agent communication
      - "1515:1515"     # Agent enrollment
      - "514:514/udp"   # Syslog collector UDP
      - "514:514/tcp"   # Syslog collector TCP
      - "55000:55000"   # API
    volumes:
      - wazuh_api_data:/var/ossec/api/configuration
      - wazuh_etc_data:/var/ossec/etc
      - wazuh_logs_data:/var/ossec/logs
      - wazuh_queue_data:/var/ossec/queue
      - wazuh_var_multigroups_data:/var/ossec/var/multigroups
      - wazuh_integrations_data:/var/ossec/integrations
      - wazuh_active_response_data:/var/ossec/active-response/bin
      - wazuh_agentless_data:/var/ossec/agentless
      - wazuh_wodles_data:/var/ossec/wodles
      - ./config/wazuh_indexer_ssl_certs:/etc/ssl:ro
      - ./config/wazuh_cluster:/var/ossec/etc/shared
    depends_on:
      wazuh-indexer:
        condition: service_healthy
    networks:
      - wazuh_network
    healthcheck:
      test: ["CMD-SHELL", "curl -sku {{ wazuh_api_user }}:{{ wazuh_api_password }} https://localhost:55000/ | grep -q '\"error\":0'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:{{ wazuh_version }}
    container_name: wazuh-dashboard
    hostname: wazuh-dashboard
    restart: unless-stopped
    environment:
      - "INDEXER_USERNAME=admin"
      - "INDEXER_PASSWORD={{ wazuh_indexer_password }}"
      - "WAZUH_API_URL=https://wazuh-manager"
      - "API_USERNAME={{ wazuh_api_user }}"
      - "API_PASSWORD={{ wazuh_api_password }}"
      - "SERVER_SSL_ENABLED=true"
{% if wazuh_enable_traefik %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.{{ wazuh_traefik_router }}.rule=Host(`{{ wazuh_fqdn }}`)"
      - "traefik.http.routers.{{ wazuh_traefik_router }}.entrypoints={{ wazuh_traefik_entrypoint }}"
      - "traefik.http.routers.{{ wazuh_traefik_router }}.tls=true"
      - "traefik.http.routers.{{ wazuh_traefik_router }}.tls.certresolver=letsencrypt"
      - "traefik.http.services.{{ wazuh_traefik_router }}.loadbalancer.server.port=5601"
      - "traefik.docker.network=traefik_public"
{% endif %}
    ports:
      - "5601:5601"
      - "443:5601"
    volumes:
      - ./config/wazuh_indexer_ssl_certs:/usr/share/wazuh-dashboard/certs:ro
      - ./config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/config/wazuh.yml:ro
    depends_on:
      wazuh-manager:
        condition: service_healthy
    networks:
      - wazuh_network
{% if wazuh_enable_traefik %}
      - traefik_public
{% endif %}
    healthcheck:
      test: ["CMD-SHELL", "curl -sku admin:admin https://localhost:5601/api/status | grep -q '\"state\":\"green\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

volumes:
  wazuh_api_data:
  wazuh_etc_data:
  wazuh_logs_data:
  wazuh_queue_data:
  wazuh_var_multigroups_data:
  wazuh_integrations_data:
  wazuh_active_response_data:
  wazuh_agentless_data:
  wazuh_wodles_data:
  wazuh_indexer_data:

networks:
  wazuh_network:
    driver: bridge
{% if wazuh_enable_traefik %}
  traefik_public:
    external: true
{% endif %}
