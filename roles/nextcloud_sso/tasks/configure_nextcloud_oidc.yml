---
# Install and Configure user_oidc app in Nextcloud

- name: Add Nextcloud container to inventory
  ansible.builtin.add_host:
    name: nextcloud_container
    ansible_host: "{{ nextcloud_sso_ip_address }}"
    ansible_user: root
    ansible_password: "{{ vault_nextcloud_root_password }}"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand="ssh -W %h:%p -q root@{{ hostvars[inventory_hostname].ansible_host }}"'
    groups: containers

- name: Check Nextcloud version
  ansible.builtin.shell:
    cmd: "{{ nextcloud_occ_command }} --version"
  delegate_to: nextcloud_container
  register: nextcloud_version
  changed_when: false

- name: Display Nextcloud version
  ansible.builtin.debug:
    msg: "Nextcloud version: {{ nextcloud_version.stdout }}"

- name: Check if user_oidc app is installed
  ansible.builtin.shell:
    cmd: "{{ nextcloud_occ_command }} app:list --output=json"
  delegate_to: nextcloud_container
  register: nextcloud_apps
  changed_when: false

- name: Parse installed apps
  ansible.builtin.set_fact:
    user_oidc_installed: "{{ 'user_oidc' in (nextcloud_apps.stdout | from_json).enabled }}"
    user_oidc_disabled: "{{ 'user_oidc' in (nextcloud_apps.stdout | from_json).disabled }}"

- name: Install user_oidc app if not present
  ansible.builtin.shell:
    cmd: "{{ nextcloud_occ_command }} app:install user_oidc"
  delegate_to: nextcloud_container
  when: not user_oidc_installed and not user_oidc_disabled
  register: app_installed

- name: Enable user_oidc app if disabled
  ansible.builtin.shell:
    cmd: "{{ nextcloud_occ_command }} app:enable user_oidc"
  delegate_to: nextcloud_container
  when: user_oidc_disabled
  register: app_enabled

- name: Get current OIDC providers
  ansible.builtin.shell:
    cmd: |
      {{ nextcloud_occ_command }} config:app:get user_oidc providers || echo '{}'
  delegate_to: nextcloud_container
  register: current_providers
  changed_when: false

- name: Parse current providers
  ansible.builtin.set_fact:
    providers_data: "{{ current_providers.stdout | default('{}') | from_json }}"

- name: Determine provider ID
  ansible.builtin.set_fact:
    provider_id: "{{ providers_data | length + 1 }}"
  when: nextcloud_sso_provider_identifier not in (providers_data | default({}) | dict2items | map(attribute='value.identifier') | list)

- name: Find existing provider ID
  ansible.builtin.set_fact:
    provider_id: "{{ item.key }}"
  loop: "{{ providers_data | default({}) | dict2items }}"
  when:
    - item.value.identifier is defined
    - item.value.identifier == nextcloud_sso_provider_identifier

- name: Configure OIDC provider in Nextcloud
  ansible.builtin.shell:
    cmd: |
      # Set provider configuration as JSON
      cat << 'EOF' | {{ nextcloud_occ_command }} config:app:set user_oidc providers --value -
      {
        "{{ provider_id | default('1') }}": {
          "identifier": "{{ nextcloud_sso_provider_identifier }}",
          "name": "{{ nextcloud_sso_provider_display_name }}",
          "icon": "{{ nextcloud_sso_provider_icon }}",
          "clientId": "{{ nextcloud_sso_client_id }}",
          "clientSecret": "{{ nextcloud_keycloak_client_secret }}",
          "discoveryEndpoint": "{{ nextcloud_sso_discovery_uri }}",
          "scope": "{{ nextcloud_sso_scopes }}",
          "uniqueUid": true,
          "checkBearer": false,
          "bearerProvisioning": false,
          "groupProvisioning": false,
          "autoProvision": {{ nextcloud_sso_auto_provision | lower }},
          "autoUpdate": {{ nextcloud_sso_auto_update | lower }}
        }
      }
      EOF
  delegate_to: nextcloud_container
  register: provider_configured

- name: Configure OIDC settings
  ansible.builtin.shell:
    cmd: |
      # Configure allow multiple user backends
      {{ nextcloud_occ_command }} config:app:set user_oidc allow_multiple_user_backends --value '{{ nextcloud_sso_allow_multiple_providers | int }}'

      # Configure ID4ME
      {{ nextcloud_occ_command }} config:app:set user_oidc id4me_enabled --value '0'
  delegate_to: nextcloud_container
  changed_when: false

- name: Configure Nextcloud trusted domains
  ansible.builtin.shell:
    cmd: |
      # Get current trusted domains
      CURRENT_DOMAINS=$({{ nextcloud_occ_command }} config:system:get trusted_domains)

      # Add our public URL if not already present
      if ! echo "$CURRENT_DOMAINS" | grep -q "nextcloud.viljo.se"; then
        # Find the next available index
        INDEX=0
        while {{ nextcloud_occ_command }} config:system:get trusted_domains $INDEX >/dev/null 2>&1; do
          INDEX=$((INDEX + 1))
        done

        # Add the domain
        {{ nextcloud_occ_command }} config:system:set trusted_domains $INDEX --value="nextcloud.viljo.se"
      fi
  delegate_to: nextcloud_container
  changed_when: false

- name: Configure overwrite protocol for HTTPS
  ansible.builtin.shell:
    cmd: |
      # Set overwrite protocol to https
      {{ nextcloud_occ_command }} config:system:set overwriteprotocol --value="https"

      # Set overwrite host
      {{ nextcloud_occ_command }} config:system:set overwritehost --value="nextcloud.viljo.se"

      # Set overwrite webroot if needed
      {{ nextcloud_occ_command }} config:system:set overwritewebroot --value=""

      # Set overwrite condition for CLI
      {{ nextcloud_occ_command }} config:system:set overwritecondaddr --value="^172\\.16\\.10\\..*$"
  delegate_to: nextcloud_container
  changed_when: false

- name: Clear Nextcloud caches
  ansible.builtin.shell:
    cmd: |
      # Clear OPcache
      {{ nextcloud_occ_command }} maintenance:mimetype:update-js

      # Update htaccess if needed
      {{ nextcloud_occ_command }} maintenance:update:htaccess || true
  delegate_to: nextcloud_container
  changed_when: false

- name: Display OIDC configuration result
  ansible.builtin.debug:
    msg:
      - "âœ… Nextcloud OIDC configuration completed"
      - "  App: user_oidc installed and enabled"
      - "  Provider: {{ nextcloud_sso_provider_identifier }}"
      - "  Display Name: {{ nextcloud_sso_provider_display_name }}"
      - "  Discovery URI: {{ nextcloud_sso_discovery_uri }}"
      - "  Auto-provisioning: {{ nextcloud_sso_auto_provision }}"