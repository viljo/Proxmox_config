---
# Configure Keycloak OIDC Client for Nextcloud

- name: Add Keycloak container to inventory
  ansible.builtin.add_host:
    name: keycloak_container
    ansible_host: "{{ nextcloud_sso_keycloak_ip_address }}"
    ansible_user: root
    ansible_password: "{{ vault_keycloak_root_password }}"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ProxyCommand="ssh -W %h:%p -q root@{{ hostvars[inventory_hostname].ansible_host }}"'
    groups: containers

- name: Login to Keycloak Admin CLI
  ansible.builtin.shell:
    cmd: |
      docker exec keycloak /opt/keycloak/bin/kcadm.sh config credentials \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm master \
        --user {{ nextcloud_sso_keycloak_admin_user }} \
        --password '{{ nextcloud_sso_keycloak_admin_password }}'
  delegate_to: keycloak_container
  no_log: true
  changed_when: false

- name: Check if Nextcloud OIDC client already exists
  ansible.builtin.shell:
    cmd: |
      docker exec keycloak /opt/keycloak/bin/kcadm.sh get clients \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm {{ nextcloud_sso_keycloak_realm }} \
        --query clientId={{ nextcloud_sso_client_id }} \
        --fields id,clientId
  delegate_to: keycloak_container
  register: nextcloud_client_check
  changed_when: false
  failed_when: false

- name: Parse client check result
  ansible.builtin.set_fact:
    nextcloud_client_exists: "{{ (nextcloud_client_check.stdout | default('[]') | from_json | length) > 0 }}"
    nextcloud_client_data: "{{ (nextcloud_client_check.stdout | default('[]') | from_json | first) | default({}) }}"

- name: Generate client secret if not provided
  ansible.builtin.set_fact:
    nextcloud_oidc_secret: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  when:
    - not nextcloud_client_exists
    - nextcloud_sso_client_secret == 'generated_at_runtime'

- name: Use provided client secret
  ansible.builtin.set_fact:
    nextcloud_oidc_secret: "{{ nextcloud_sso_client_secret }}"
  when: nextcloud_sso_client_secret != 'generated_at_runtime'

- name: Create Nextcloud OIDC client
  ansible.builtin.shell:
    cmd: |
      docker exec keycloak /opt/keycloak/bin/kcadm.sh create clients \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm {{ nextcloud_sso_keycloak_realm }} \
        -s clientId={{ nextcloud_sso_client_id }} \
        -s name="{{ nextcloud_sso_client_description }}" \
        -s enabled=true \
        -s clientAuthenticatorType=client-secret \
        -s secret="{{ nextcloud_oidc_secret }}" \
        -s standardFlowEnabled=true \
        -s implicitFlowEnabled=false \
        -s directAccessGrantsEnabled=false \
        -s serviceAccountsEnabled=false \
        -s publicClient=false \
        -s frontchannelLogout=true \
        -s protocol=openid-connect \
        -s fullScopeAllowed=true \
        -s redirectUris='["{{ nextcloud_sso_public_url }}/apps/user_oidc/code","{{ nextcloud_sso_public_url }}/index.php/apps/user_oidc/code"]' \
        -s webOrigins='["{{ nextcloud_sso_public_url }}"]' \
        -s attributes='{"post.logout.redirect.uris":"{{ nextcloud_sso_public_url }}/*","backchannel.logout.session.required":"true","backchannel.logout.revoke.offline.tokens":"false"}'
  delegate_to: keycloak_container
  when: not nextcloud_client_exists
  no_log: true
  register: client_created

- name: Update existing Nextcloud OIDC client
  ansible.builtin.shell:
    cmd: |
      docker exec keycloak /opt/keycloak/bin/kcadm.sh update clients/{{ nextcloud_client_data.id }} \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm {{ nextcloud_sso_keycloak_realm }} \
        -s name="{{ nextcloud_sso_client_description }}" \
        -s enabled=true \
        -s standardFlowEnabled=true \
        -s implicitFlowEnabled=false \
        -s directAccessGrantsEnabled=false \
        -s serviceAccountsEnabled=false \
        -s publicClient=false \
        -s frontchannelLogout=true \
        -s protocol=openid-connect \
        -s fullScopeAllowed=true \
        -s redirectUris='["{{ nextcloud_sso_public_url }}/apps/user_oidc/code","{{ nextcloud_sso_public_url }}/index.php/apps/user_oidc/code"]' \
        -s webOrigins='["{{ nextcloud_sso_public_url }}"]' \
        -s attributes='{"post.logout.redirect.uris":"{{ nextcloud_sso_public_url }}/*","backchannel.logout.session.required":"true"}'
  delegate_to: keycloak_container
  when: nextcloud_client_exists
  no_log: true
  register: client_updated

- name: Get client secret if client already existed
  ansible.builtin.shell:
    cmd: |
      docker exec keycloak /opt/keycloak/bin/kcadm.sh get clients/{{ nextcloud_client_data.id }}/client-secret \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm {{ nextcloud_sso_keycloak_realm }}
  delegate_to: keycloak_container
  when: nextcloud_client_exists
  no_log: true
  register: existing_client_secret

- name: Set client secret fact for existing client
  ansible.builtin.set_fact:
    nextcloud_oidc_secret: "{{ (existing_client_secret.stdout | from_json).value }}"
  when: nextcloud_client_exists

- name: Configure client mappers for user attributes
  ansible.builtin.shell:
    cmd: |
      # Get client ID
      CLIENT_ID=$(docker exec keycloak /opt/keycloak/bin/kcadm.sh get clients \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm {{ nextcloud_sso_keycloak_realm }} \
        --query clientId={{ nextcloud_sso_client_id }} \
        --fields id | grep -o '"id" : "[^"]*"' | cut -d'"' -f4)

      # Create username mapper
      docker exec keycloak /opt/keycloak/bin/kcadm.sh create clients/$CLIENT_ID/protocol-mappers/models \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm {{ nextcloud_sso_keycloak_realm }} \
        -s name="nextcloud-username" \
        -s protocol="openid-connect" \
        -s protocolMapper="oidc-usermodel-property-mapper" \
        -s config.user.attribute="username" \
        -s config.claim.name="preferred_username" \
        -s config.jsonType.label="String" \
        -s config.id.token.claim="true" \
        -s config.access.token.claim="true" \
        -s config.userinfo.token.claim="true" 2>/dev/null || true

      # Create email verified mapper
      docker exec keycloak /opt/keycloak/bin/kcadm.sh create clients/$CLIENT_ID/protocol-mappers/models \
        --server http://localhost:{{ nextcloud_sso_keycloak_port }} \
        --realm {{ nextcloud_sso_keycloak_realm }} \
        -s name="email-verified" \
        -s protocol="openid-connect" \
        -s protocolMapper="oidc-usermodel-property-mapper" \
        -s config.user.attribute="emailVerified" \
        -s config.claim.name="email_verified" \
        -s config.jsonType.label="boolean" \
        -s config.id.token.claim="true" \
        -s config.access.token.claim="true" \
        -s config.userinfo.token.claim="true" 2>/dev/null || true
  delegate_to: keycloak_container
  changed_when: false

- name: Save client configuration for Nextcloud
  ansible.builtin.set_fact:
    nextcloud_keycloak_client_secret: "{{ nextcloud_oidc_secret }}"
    cacheable: yes

- name: Display Keycloak client configuration result
  ansible.builtin.debug:
    msg:
      - "âœ… Keycloak OIDC client configured for Nextcloud"
      - "  Client ID: {{ nextcloud_sso_client_id }}"
      - "  Redirect URIs configured"
      - "  User attribute mappers configured"
      - "  Client secret stored for Nextcloud configuration"