---
# Template Playbook for New Service Deployment
#
# This template ensures all mandatory requirements are met:
# 1. DNS entry (pre-deployment check)
# 2. HTTPS certificate (Traefik configuration)
# 3. SSO integration (documented, implemented in service role)
#
# Usage:
#   1. Copy this file: cp playbooks/templates/new-service-deploy.yml playbooks/servicename-deploy.yml
#   2. Replace 'servicename' with your actual service name throughout
#   3. Add DNS and Traefik entries to inventory/group_vars/all/main.yml FIRST
#   4. Create service role: roles/servicename/
#   5. Run: ansible-playbook -i inventory/hosts.yml playbooks/servicename-deploy.yml --ask-vault-pass
#
# See: docs/SERVICE_IMPLEMENTATION_PIPELINE.md for complete implementation guide

- name: Pre-deployment validation
  hosts: localhost
  gather_facts: false
  vars:
    service_name: servicename  # CHANGE THIS
    service_subdomain: "{{ service_name }}"
    public_domain: "{{ public_domain | default('viljo.se') }}"

  tasks:
    - name: Validate mandatory prerequisites
      block:
        - name: Check DNS entry exists in inventory
          ansible.builtin.assert:
            that:
              - loopia_dns_records is defined
              - loopia_dns_records | selectattr('host', 'equalto', service_subdomain) | list | length > 0
            fail_msg: |
              DNS entry for {{ service_subdomain }} not found in inventory.

              Add to inventory/group_vars/all/main.yml:
                loopia_dns_records:
                  - host: {{ service_subdomain }}
                    ttl: 600

              Then deploy DNS:
                ansible-playbook -i inventory/hosts.yml playbooks/loopia-dns-deploy.yml --ask-vault-pass
            success_msg: "✓ DNS entry found in inventory"

        - name: Check Traefik service entry exists in inventory
          ansible.builtin.assert:
            that:
              - traefik_services is defined
              - traefik_services | selectattr('name', 'equalto', service_name) | list | length > 0
            fail_msg: |
              Traefik service entry for {{ service_name }} not found in inventory.

              Add to inventory/group_vars/all/main.yml:
                traefik_services:
                  - name: {{ service_name }}
                    host: "{{ service_subdomain }}.{{ '{{' }} public_domain {{ '}}' }}"
                    container_id: "{{ '{{' }} {{ service_name }}_container_id {{ '}}' }}"
                    port: 8080  # Adjust to actual service port

              Then deploy Traefik:
                ansible-playbook -i inventory/hosts.yml playbooks/traefik-deploy.yml --ask-vault-pass
            success_msg: "✓ Traefik service entry found in inventory"

        - name: Check OIDC client secret exists in vault
          ansible.builtin.assert:
            that:
              - lookup('vars', 'vault_' ~ service_name ~ '_oidc_client_secret', default='') | length > 0
            fail_msg: |
              OIDC client secret not found in vault.

              1. Create Keycloak client:
                 - Open: https://keycloak.{{ public_domain }}
                 - Navigate: Clients → Create client
                 - Client ID: {{ service_name }}
                 - Client authentication: ON
                 - Valid redirect URIs: https://{{ service_subdomain }}.{{ public_domain }}/*

              2. Add secret to vault:
                 ansible-vault edit inventory/group_vars/all/secrets.yml --vault-password-file=.vault_pass.txt

              3. Add line:
                 vault_{{ service_name }}_oidc_client_secret: "paste-secret-from-keycloak"

              See: docs/SERVICE_IMPLEMENTATION_PIPELINE.md Section B, Step 3
            success_msg: "✓ OIDC client secret found in vault"
          ignore_errors: true  # Allow deployment to continue even if SSO not configured yet
          register: oidc_check

        - name: Display SSO configuration reminder
          ansible.builtin.debug:
            msg: |
              ⚠️  REMINDER: SSO Integration Required

              After service deployment, you MUST configure SSO (Step 3.5 of workflow).

              SSO is MANDATORY for production. Service cannot be marked production-ready without it.

              See: docs/SERVICE_IMPLEMENTATION_PIPELINE.md Section B, Step 3
          when: oidc_check is failed

      tags: ['validation', 'preflight']

- name: Deploy servicename service
  hosts: proxmox_admin  # Or appropriate host group
  become: true
  gather_facts: true

  vars:
    service_name: servicename  # CHANGE THIS

  # Pre-tasks: Verify DNS before proceeding
  pre_tasks:
    - name: Verify DNS resolution
      ansible.builtin.command:
        cmd: "dig +short {{ service_name }}.{{ public_domain }} @1.1.1.1"
      register: dns_check
      changed_when: false
      failed_when: dns_check.stdout | trim | length == 0
      delegate_to: localhost
      tags: ['validation']

    - name: Display DNS resolution result
      ansible.builtin.debug:
        msg: "✓ DNS resolves to: {{ dns_check.stdout | trim }}"
      tags: ['validation']

  # Main deployment
  roles:
    - role: servicename  # CHANGE THIS to match your role name
      tags: ['deploy', 'servicename']

  # Post-tasks: Verify deployment and requirements
  post_tasks:
    - name: Wait for service to be ready
      ansible.builtin.uri:
        url: "http://{{ servicename_ip | default('172.16.10.XXX') }}:{{ servicename_port | default('8080') }}/health"
        status_code: 200
      retries: 30
      delay: 10
      register: health_check
      ignore_errors: true
      tags: ['validation']

    - name: Display service health status
      ansible.builtin.debug:
        msg: |
          {% if health_check is succeeded %}
          ✓ Service health check passed
          {% else %}
          ⚠ Service health check failed or not implemented
          {% endif %}
      tags: ['validation']

    - name: Verify HTTPS certificate (with retry for initial issuance)
      ansible.builtin.uri:
        url: "https://{{ service_name }}.{{ public_domain }}"
        method: HEAD
        validate_certs: yes
        status_code: [200, 301, 302, 303, 307, 308]  # Accept redirects
      register: https_check
      retries: 20
      delay: 30  # Certificate issuance can take 1-3 minutes
      until: https_check is succeeded
      ignore_errors: true
      tags: ['validation']

    - name: Display HTTPS status
      ansible.builtin.debug:
        msg: |
          {% if https_check is succeeded %}
          ✓ HTTPS accessible with valid certificate
            Status: {{ https_check.status }}
            URL: https://{{ service_name }}.{{ public_domain }}
          {% else %}
          ✗ HTTPS check failed
            This may be normal during initial deployment
            Monitor Traefik logs for certificate issuance:
              pct exec 167 -- docker logs -f traefik
          {% endif %}
      tags: ['validation']

    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          ========================================
          Service Deployment Summary
          ========================================
          Service: {{ service_name }}
          URL: https://{{ service_name }}.{{ public_domain }}

          Status:
          {% if dns_check is succeeded %}
            ✓ DNS resolves correctly
          {% endif %}
          {% if health_check is succeeded %}
            ✓ Service health check passed
          {% endif %}
          {% if https_check is succeeded %}
            ✓ HTTPS certificate valid
          {% else %}
            ⚠ HTTPS certificate pending (monitor Traefik logs)
          {% endif %}

          ========================================
          NEXT STEPS (MANDATORY)
          ========================================

          Step 3.5: Configure SSO Integration

          1. Create Keycloak client (if not already done):
             https://keycloak.{{ public_domain }}/admin

          2. Configure service for OIDC:
             See role documentation: roles/{{ service_name }}/README.md

          3. Test SSO login flow:
             Open: https://{{ service_name }}.{{ public_domain }}
             Test: Complete login via GitLab.com

          4. Verify requirements:
             ./scripts/verify-service-requirements.sh {{ service_name }}

          Documentation:
            - Implementation Pipeline: docs/SERVICE_IMPLEMENTATION_PIPELINE.md
            - Quick Reference: docs/SSO_DNS_HTTPS_QUICKREF.md
            - Workflow: docs/NEW_SERVICE_WORKFLOW.md

          ⚠️  SERVICE IS NOT PRODUCTION-READY WITHOUT SSO CONFIGURATION
      tags: ['always']

- name: Verify all mandatory requirements
  hosts: localhost
  gather_facts: false

  vars:
    service_name: servicename  # CHANGE THIS

  tasks:
    - name: Run verification script
      ansible.builtin.command:
        cmd: "./scripts/verify-service-requirements.sh {{ service_name }}"
      register: verify_result
      changed_when: false
      ignore_errors: true
      tags: ['validation', 'verify']

    - name: Display verification results
      ansible.builtin.debug:
        msg: "{{ verify_result.stdout_lines }}"
      tags: ['validation', 'verify']

    - name: Final deployment status
      ansible.builtin.debug:
        msg: |
          ========================================
          Deployment Status
          ========================================
          {% if verify_result.rc == 0 %}
          ✓ Automated verification passed

          Complete manual SSO testing:
            1. Open https://{{ service_name }}.{{ public_domain }}
            2. Test SSO login flow
            3. Verify user auto-provisioning
            4. Grant admin access if needed
            5. Update service documentation

          Once SSO is verified, service is ready for production.
          {% else %}
          ✗ Verification failed

          Fix issues before proceeding to Step 3.5 (SSO Integration).

          Common issues:
            - DNS not propagated: Wait 5-10 minutes, check again
            - Certificate not issued: Check Traefik logs
            - Service not responding: Check service logs

          Troubleshooting:
            See docs/SERVICE_IMPLEMENTATION_PIPELINE.md Section B
          {% endif %}
      tags: ['always']
