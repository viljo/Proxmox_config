---
# Configure Nextcloud SSO via Keycloak OIDC (GitLab.com OAuth)
# This playbook implements true single sign-on for Nextcloud using the existing
# GitLab.com â†’ Keycloak â†’ Service authentication chain

- name: Configure Nextcloud SSO with Keycloak OIDC
  hosts: proxmox_admin
  gather_facts: yes
  vars:
    # Override any defaults here if needed
    nextcloud_sso_button_text: "Sign in with GitLab SSO"
    nextcloud_sso_auto_provision: true
    nextcloud_sso_auto_update: true
    nextcloud_sso_admin_email: "anders@viljo.se"
    nextcloud_sso_admin_username: "anders"

  pre_tasks:
    - name: Display SSO implementation plan
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "    Nextcloud SSO Configuration"
          - "============================================"
          - ""
          - "This playbook will:"
          - "  1. Create OIDC client in Keycloak for Nextcloud"
          - "  2. Install and configure user_oidc app in Nextcloud"
          - "  3. Set up automatic user provisioning"
          - "  4. Configure admin access for {{ nextcloud_sso_admin_email }}"
          - "  5. Verify the complete SSO configuration"
          - ""
          - "Authentication flow:"
          - "  User â†’ Nextcloud â†’ Keycloak â†’ GitLab.com OAuth"
          - ""
          - "Press Ctrl+C to abort, or wait to continue..."
      tags: always

    - name: Wait for user confirmation
      ansible.builtin.pause:
        seconds: 5
      tags: always

  tasks:
    - name: Verify required variables are set
      ansible.builtin.assert:
        that:
          - vault_keycloak_admin_password is defined
          - vault_nextcloud_root_password is defined
          - vault_keycloak_root_password is defined
        fail_msg: "Required vault variables are not set. Please check inventory/group_vars/all/secrets.yml"
      tags: always

    - name: Include Nextcloud SSO role
      ansible.builtin.include_role:
        name: nextcloud_sso
      tags:
        - nextcloud
        - sso
        - keycloak

  post_tasks:
    - name: Save OIDC client secret to vault variables (for reference)
      ansible.builtin.debug:
        msg:
          - ""
          - "ðŸ’¾ IMPORTANT: Save this client secret in your Ansible vault!"
          - "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          - ""
          - "Add to inventory/group_vars/all/secrets.yml:"
          - ""
          - "vault_nextcloud_oidc_client_secret: {{ nextcloud_keycloak_client_secret }}"
          - ""
          - "This secret is needed if you need to reconfigure the integration."
      when: nextcloud_keycloak_client_secret is defined
      tags: always

    - name: Display completion summary
      ansible.builtin.debug:
        msg:
          - ""
          - "============================================"
          - "    âœ… SSO Configuration Complete!"
          - "============================================"
          - ""
          - "Nextcloud is now configured for SSO via Keycloak/GitLab.com"
          - ""
          - "Test the integration:"
          - "  1. Visit: https://nextcloud.viljo.se"
          - "  2. Click '{{ nextcloud_sso_button_text }}'"
          - "  3. Authenticate with GitLab.com"
          - "  4. You should be logged into Nextcloud"
          - ""
          - "Admin user: {{ nextcloud_sso_admin_email }}"
          - ""
          - "Note: Admin rights will be granted after first SSO login."
          - "Run this playbook again after first login to ensure admin access."
      tags: always

# Usage:
# ansible-playbook -i inventory/hosts.yml playbooks/nextcloud_sso.yml --ask-vault-pass
#
# To only verify existing configuration:
# ansible-playbook -i inventory/hosts.yml playbooks/nextcloud_sso.yml --tags verify --ask-vault-pass
#
# To reconfigure just the Nextcloud side:
# ansible-playbook -i inventory/hosts.yml playbooks/nextcloud_sso.yml --tags nextcloud --ask-vault-pass