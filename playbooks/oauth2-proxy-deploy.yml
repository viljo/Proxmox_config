---
- name: Deploy oauth2-proxy for Traefik Forward Auth SSO
  hosts: proxmox_admin
  gather_facts: false
  vars_files:
    - ../inventory/group_vars/all/oauth2_proxy.yml

  tasks:
    - name: Load oauth2-proxy variables
      ansible.builtin.include_vars:
        file: ../inventory/group_vars/all/oauth2_proxy.yml
      tags: always

    - name: Apply oauth2-proxy role
      ansible.builtin.include_role:
        name: oauth2_proxy_api
        public: yes

    # ================================================================================
    # SERVICE VERIFICATION
    # ================================================================================

    - name: "VERIFY: Test oauth2-proxy health endpoint (from container)"
      ansible.builtin.command:
        cmd: "pct exec {{ oauth2_proxy_container_id }} -- curl -sf http://localhost:{{ oauth2_proxy_service_port }}/ping"
      register: oauth2_proxy_ping
      failed_when: false
      changed_when: false

    - name: "VERIFY: Test oauth2-proxy HTTPS external (from Proxmox host)"
      ansible.builtin.command:
        cmd: "curl -sfI {{ oauth2_proxy_external_url }}/ping"
      register: oauth2_proxy_https
      failed_when: false
      changed_when: false

    - name: "VERIFY: Display verification results"
      ansible.builtin.debug:
        msg:
          - "=== oauth2-proxy Verification Results ==="
          - "Health Internal (localhost:{{ oauth2_proxy_service_port }}/ping): {% if oauth2_proxy_ping.rc == 0 %}PASS ✅{% else %}FAIL ❌ (rc={{ oauth2_proxy_ping.rc }}){% endif %}"
          - "HTTPS External ({{ oauth2_proxy_external_url }}/ping): {% if oauth2_proxy_https.rc == 0 %}PASS ✅{% else %}FAIL ❌ (rc={{ oauth2_proxy_https.rc }}){% endif %}"

    - name: "VERIFY: Fail if critical checks failed"
      ansible.builtin.fail:
        msg:
          - "❌ oauth2-proxy verification FAILED"
          - "  Health Internal: rc={{ oauth2_proxy_ping.rc | default('ERROR') }}"
          - "  HTTPS External: rc={{ oauth2_proxy_https.rc | default('ERROR') }}"
          - ""
          - "Troubleshooting:"
          - "  1. Check oauth2-proxy logs: pct exec {{ oauth2_proxy_container_id }} -- docker logs oauth2-proxy"
          - "  2. Check oauth2-proxy status: pct exec {{ oauth2_proxy_container_id }} -- docker ps | grep oauth2-proxy"
          - "  3. Check Traefik routing for auth.{{ public_domain }}"
      when: >
        oauth2_proxy_ping.rc is not defined or
        oauth2_proxy_ping.rc != 0

    - name: "VERIFY: Display success message"
      ansible.builtin.debug:
        msg:
          - "✅ oauth2-proxy deployed and verified successfully"
          - "  Container: {{ oauth2_proxy_container_id }} (Firewall)"
          - "  Internal Port: {{ oauth2_proxy_service_port }}"
          - "  External URL: {{ oauth2_proxy_external_url }}"
          - "  Keycloak OIDC: {{ oauth2_proxy_oidc_issuer_url }}"
          - "  Status: FUNCTIONAL ✅"
          - ""
          - "Next Steps:"
          - "  1. Configure Traefik middleware for forward auth"
          - "  2. Apply middleware to services (Mattermost, etc.)"
          - "  3. Test SSO login flow"
