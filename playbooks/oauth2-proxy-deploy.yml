---
# Deploy OAuth2-Proxy for GitLab.com SSO
# Creates multiple oauth2-proxy instances (one per protected service)

- name: Deploy OAuth2-Proxy SSO Authentication
  hosts: proxmox_admin
  gather_facts: false
  vars_files:
    - ../inventory/group_vars/all/oauth2_proxy.yml

  tasks:
    - name: Load oauth2-proxy variables
      ansible.builtin.include_vars:
        file: ../inventory/group_vars/all/oauth2_proxy.yml
      tags: always

    - name: Apply oauth2-proxy role
      ansible.builtin.include_role:
        name: oauth2_proxy
        public: yes

    # ================================================================================
    # SERVICE VERIFICATION
    # ================================================================================

    - name: "VERIFY: Test oauth2-proxy health endpoints"
      ansible.builtin.command:
        cmd: "pct exec {{ oauth2_proxy_container_id }} -- curl -sf http://localhost:{{ oauth2_proxy_service_port }}/ping"
      register: oauth2_proxy_ping
      loop: "{{ oauth2_proxy_services }}"
      failed_when: false
      changed_when: false

    - name: "VERIFY: Test oauth2-proxy HTTPS external access"
      ansible.builtin.command:
        cmd: "curl -sfI https://{{ item.subdomain }}.{{ public_domain }}/"
      register: oauth2_proxy_https
      loop: "{{ oauth2_proxy_services }}"
      failed_when: false
      changed_when: false

    - name: "VERIFY: Display verification results"
      ansible.builtin.debug:
        msg:
          - "=== OAuth2-Proxy Verification Results ==="
          - "Services tested: {{ oauth2_proxy_services | length }}"
          - "Ping tests passed: {{ oauth2_proxy_ping.results | selectattr('rc', 'eq', 0) | list | length }}"
          - "HTTPS tests passed: {{ oauth2_proxy_https.results | selectattr('rc', 'eq', 0) | list | length }}"
          - ""
          - "Auth endpoint: {{ oauth2_proxy_external_url }}"
          - "Provider: {{ oauth2_proxy_provider }} ({{ oauth2_proxy_oidc_issuer_url }})"
          - "Authentication headers: ENABLED"

    - name: "VERIFY: Check for any failures"
      ansible.builtin.set_fact:
        has_failures: "{{ oauth2_proxy_ping.results | selectattr('rc', 'ne', 0) | list | length > 0 }}"

    - name: "VERIFY: Display success message"
      ansible.builtin.debug:
        msg:
          - "✅ OAuth2-Proxy deployed and verified successfully"
          - "  Container: {{ oauth2_proxy_container_id }} (Coolify LXC)"
          - "  Services protected: {{ oauth2_proxy_services | length }}"
          - "  Cookie domain: {{ oauth2_proxy_cookie_domains }}"
          - "  Email restriction: {{ oauth2_proxy_email_domains }}"
          - "  Authentication headers: ENABLED"
          - "  Status: FUNCTIONAL ✅"
          - ""
          - "Users log in once with GitLab and session is shared across all services!"
          - "Authentication headers (X-Auth-Request-*, X-Forwarded-*) are passed to backend services."
      when: not has_failures

    - name: "VERIFY: Display failure warning"
      ansible.builtin.debug:
        msg:
          - "⚠️  Some oauth2-proxy services may have issues"
          - "  Check logs: pct exec {{ oauth2_proxy_container_id }} -- docker logs oauth2-proxy-<service>"
          - "  Check status: pct exec {{ oauth2_proxy_container_id }} -- docker ps | grep oauth2-proxy"
      when: has_failures
