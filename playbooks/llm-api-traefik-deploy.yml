---
# Playbook: Deploy LLM API Traefik Configuration
# Description: Configure Traefik routing for llama.cpp OpenAI-compatible API
# Prerequisites:
#   - VM 201 (ipex-llm) with llama.cpp server running on port 8000
#   - LXC 200 with Docker Traefik (handles external traffic via NAT)
#   - DNS record for llm-api.viljo.se pointing to public IP

- name: Deploy LLM API Traefik Configuration
  hosts: proxmox_admin
  gather_facts: false

  vars:
    lxc_id: 200
    service_subdomain: llm-api
    service_domain: "{{ service_subdomain }}.{{ public_domain }}"
    # llama.cpp server with OpenAI-compatible API (Intel Arc Pro B60 GPU)
    llm_api_backend: "http://172.31.31.201:8000"
    traefik_dynamic_path: /opt/docker-stack/traefik/dynamic

  pre_tasks:
    - name: Display deployment plan
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "LLM API Traefik Configuration"
          - "=========================================="
          - "This playbook will deploy:"
          - "- Traefik dynamic configuration for LLM API"
          - "- External access to llama.cpp OpenAI-compatible API"
          - ""
          - "Configuration:"
          - "  LXC: {{ lxc_id }} (Docker Traefik)"
          - "  Domain: {{ service_domain }}"
          - "  Backend: {{ llm_api_backend }}"
          - "  GPU: Intel Arc Pro B60 24GB (VM 201)"
          - "  Model: Qwen2.5-Coder-7B-Instruct (Q4_K_M)"
          - ""
          - "API Authentication:"
          - "  Uses Bearer token (API key: sk-local-connector)"
          - ""
          - "Traefik Integration:"
          - "  - Automatic HTTPS via Let's Encrypt (TLS challenge)"
          - "  - Routing: Host(`{{ service_domain }}`)"
          - "=========================================="

  tasks:
    - name: Create Traefik dynamic config directory
      ansible.builtin.command: >
        pct exec {{ lxc_id }} -- mkdir -p {{ traefik_dynamic_path }}
      changed_when: true

    - name: Create Traefik dynamic configuration file
      ansible.builtin.copy:
        dest: /tmp/llm-api-traefik.yml
        mode: '0644'
        content: |
          http:
            routers:
              llm-api:
                rule: "Host(`{{ service_domain }}`)"
                service: llm-api
                entryPoints:
                  - websecure
                tls:
                  certResolver: letsencrypt

            services:
              llm-api:
                loadBalancer:
                  servers:
                    - url: "{{ llm_api_backend }}"
                  passHostHeader: true
                  responseForwarding:
                    flushInterval: "100ms"

    - name: Copy config to LXC
      ansible.builtin.command: >
        pct push {{ lxc_id }} /tmp/llm-api-traefik.yml {{ traefik_dynamic_path }}/llm-api.yml
      changed_when: true

    - name: Check if Traefik has file provider
      ansible.builtin.command: >
        pct exec {{ lxc_id }} -- docker exec traefik cat /proc/1/cmdline
      register: traefik_cmdline
      changed_when: false

    - name: Update Traefik docker-compose if needed
      when: "'providers.file' not in traefik_cmdline.stdout"
      block:
        - name: Create updated docker-compose.yml
          ansible.builtin.copy:
            dest: /tmp/traefik-compose.yml
            mode: '0644'
            content: |
              services:
                traefik:
                  image: traefik:latest
                  container_name: traefik
                  restart: unless-stopped

                  environment:
                    - DOCKER_API_VERSION=1.46

                  command:
                    # API and Dashboard
                    - --api.dashboard=true
                    - --api.insecure=false

                    # Docker provider
                    - --providers.docker=true
                    - --providers.docker.exposedbydefault=false
                    - --providers.docker.network=traefik_public

                    # File provider for external routes
                    - --providers.file.directory=/dynamic
                    - --providers.file.watch=true

                    # Entrypoints
                    - --entrypoints.web.address=:80
                    - --entrypoints.websecure.address=:443

                    # HTTP to HTTPS redirect
                    - --entrypoints.web.http.redirections.entrypoint.to=websecure
                    - --entrypoints.web.http.redirections.entrypoint.scheme=https

                    # Let's Encrypt configuration
                    - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
                    - --certificatesresolvers.letsencrypt.acme.email=anders@viljo.se
                    - --certificatesresolvers.letsencrypt.acme.storage=/acme.json

                    # Logging
                    - --log.level=INFO
                    - --accesslog=true

                  ports:
                    - "80:80"
                    - "443:443"

                  volumes:
                    - /var/run/docker.sock:/var/run/docker.sock:ro
                    - /opt/docker-stack/traefik/acme.json:/acme.json
                    - /opt/docker-stack/traefik/dynamic:/dynamic:ro

                  networks:
                    - traefik_public

                  labels:
                    # Enable Traefik for this service
                    - "traefik.enable=true"

                    # Dashboard router
                    - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.{{ public_domain }}`)"
                    - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
                    - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
                    - "traefik.http.routers.traefik-dashboard.service=api@internal"

                    # Protect dashboard with OAuth2
                    - "traefik.http.routers.traefik-dashboard.middlewares=oauth2-auth@docker"

                    # Explicitly set port for dashboard
                    - "traefik.http.services.traefik-dashboard.loadbalancer.server.port=8080"

              networks:
                traefik_public:
                  external: true

        - name: Copy docker-compose to LXC
          ansible.builtin.command: >
            pct push {{ lxc_id }} /tmp/traefik-compose.yml /opt/docker-stack/traefik/docker-compose.yml
          changed_when: true

        - name: Recreate Traefik container
          ansible.builtin.command: >
            pct exec {{ lxc_id }} -- bash -c 'cd /opt/docker-stack/traefik && docker compose up -d'
          changed_when: true

    - name: Wait for Traefik to reload config
      ansible.builtin.wait_for:
        timeout: 5
      delegate_to: localhost

    - name: Test API endpoint
      ansible.builtin.uri:
        url: "https://{{ service_domain }}/v1/models"
        method: GET
        headers:
          Authorization: "Bearer sk-local-connector"
        validate_certs: true
        status_code: 200
      register: api_test
      delegate_to: localhost
      failed_when: false
      retries: 6
      delay: 10

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "LLM API Traefik Configuration Complete"
          - "=========================================="
          - ""
          - "API Endpoint:"
          - "  URL: https://{{ service_domain }}"
          - "  Status: {{ 'Available' if api_test.status == 200 else 'Check logs' }}"
          - "  SSL: Let's Encrypt"
          - ""
          - "Backend:"
          - "  llama.cpp server: {{ llm_api_backend }}"
          - "  GPU: Intel Arc Pro B60 24GB"
          - "  Model: Qwen2.5-Coder-7B-Instruct (Q4_K_M)"
          - ""
          - "=========================================="
          - "USAGE EXAMPLES"
          - "=========================================="
          - ""
          - "List models:"
          - "  curl https://{{ service_domain }}/v1/models \\"
          - "    -H 'Authorization: Bearer sk-local-connector'"
          - ""
          - "Chat completion:"
          - "  curl https://{{ service_domain }}/v1/chat/completions \\"
          - "    -H 'Authorization: Bearer sk-local-connector' \\"
          - "    -H 'Content-Type: application/json' \\"
          - "    -d '{"
          - '      "model": "qwen2.5-coder-7b-instruct",'
          - '      "messages": [{"role": "user", "content": "Hello"}]'
          - "    }'"
          - ""
          - "=========================================="
