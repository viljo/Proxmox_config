---
# Playbook: WireGuard VPN Server Deployment
# Purpose: Deploy WireGuard VPN server for secure remote access to management network
# Infrastructure: Unprivileged LXC container (CT 190) on management network (vmbr0)
# Specification: specs/planned/006-wireguard-vpn/spec.md

- name: Deploy WireGuard VPN Server
  hosts: proxmox
  become: true
  gather_facts: true

  pre_tasks:
    - name: Verify Ansible Vault variables are defined
      ansible.builtin.assert:
        that:
          - vault_wireguard_root_password is defined
          - vault_wireguard_root_password | length > 0
          - vault_wireguard_private_key is defined
          - vault_wireguard_private_key | length > 0
        fail_msg: "Required Vault variables not defined. Ensure vault_wireguard_root_password and vault_wireguard_private_key are set in inventory/group_vars/all/secrets.yml"
        success_msg: "Vault variables validated successfully"

    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "Deploying WireGuard VPN Server"
          - "Container ID: {{ wireguard_container_id }}"
          - "Hostname: {{ wireguard_hostname }}.{{ wireguard_domain }}"
          - "Network: {{ wireguard_bridge }} ({{ wireguard_ip_config }})"
          - "VPN Tunnel: {{ wireguard_tunnel_address }}"
          - "Listen Port: {{ wireguard_listen_port }}"
          - "Configured Peers: {{ wireguard_peer_configs | length }}"

  roles:
    - role: wireguard
      tags:
        - wireguard
        - vpn
        - infrastructure

  post_tasks:
    - name: Wait for WireGuard service to stabilize
      ansible.builtin.pause:
        seconds: 5
        prompt: "Waiting for WireGuard service to stabilize..."

    - name: Verify WireGuard service is running
      ansible.builtin.command:
        cmd: pct exec {{ wireguard_container_id }} -- systemctl is-active wg-quick@{{ wireguard_interface }}
      register: wireguard_service_status
      changed_when: false
      failed_when: wireguard_service_status.stdout != 'active'

    - name: Get WireGuard interface status
      ansible.builtin.command:
        cmd: pct exec {{ wireguard_container_id }} -- wg show {{ wireguard_interface }}
      register: wireguard_interface_status
      changed_when: false

    - name: Display WireGuard status
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "WireGuard VPN Server Deployment Complete"
          - "=========================================="
          - ""
          - "Service Status: {{ wireguard_service_status.stdout }}"
          - ""
          - "Interface Status:"
          - "{{ wireguard_interface_status.stdout_lines }}"
          - ""
          - "Next Steps:"
          - "1. Configure firewall to forward UDP port 51820 to {{ wireguard_ip_config.split('/')[0] }}"
          - "2. Generate client keys: wg genkey | tee client_private.key | wg pubkey > client_public.key"
          - "3. Add peer configuration to inventory/group_vars/all/wireguard.yml"
          - "4. Re-run this playbook to update peer configuration"
          - "5. Create client configuration file with server public key and endpoint"
          - ""
          - "Get server public key: pct exec {{ wireguard_container_id }} -- wg show {{ wireguard_interface }} public-key"
          - "Check logs: pct exec {{ wireguard_container_id }} -- journalctl -u wg-quick@{{ wireguard_interface }} -n 50"
          - ""
          - "=========================================="

    - name: Remind about manual firewall configuration
      ansible.builtin.debug:
        msg:
          - "IMPORTANT: Manual firewall configuration required!"
          - ""
          - "Configure your firewall/router to forward UDP port 51820 to {{ wireguard_ip_config.split('/')[0] }}"
          - ""
          - "Example for container 101 (if using nftables on firewall LXC):"
          - "  nft add rule inet filter forward iifname eth0 udp dport 51820 ct state new,established counter accept"
          - "  nft add rule inet nat prerouting iifname eth0 udp dport 51820 dnat to {{ wireguard_ip_config.split('/')[0] }}"
          - ""
          - "Test external connectivity:"
          - "  nc -u -v YOUR_PUBLIC_IP 51820"
