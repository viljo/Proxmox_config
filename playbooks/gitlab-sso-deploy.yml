---
- name: Configure GitLab SSO with Keycloak OIDC
  hosts: proxmox_admin
  gather_facts: true
  become: false

  pre_tasks:
    - name: Verify Keycloak is accessible
      ansible.builtin.uri:
        url: "https://{{ keycloak_hostname_url }}/health/ready"
        method: GET
        status_code: [200]
        validate_certs: yes
        timeout: 10
      register: keycloak_health
      retries: 3
      delay: 5

    - name: Verify GitLab is accessible
      ansible.builtin.uri:
        url: "{{ gitlab_external_url }}"
        method: GET
        status_code: [200, 302]
        validate_certs: yes
        timeout: 10
      register: gitlab_health
      retries: 3
      delay: 5

    - name: Display pre-flight check results
      ansible.builtin.debug:
        msg:
          - "Pre-flight checks completed"
          - "  Keycloak: {{ keycloak_health.status }}"
          - "  GitLab: {{ gitlab_health.status }}"

  roles:
    - role: gitlab_sso

  post_tasks:
    - name: Display completion summary
      ansible.builtin.debug:
        msg:
          - ""
          - "========================================="
          - "GitLab SSO Configuration Complete"
          - "========================================="
          - ""
          - "Services Configured:"
          - "  GitLab URL: {{ gitlab_external_url }}"
          - "  Keycloak URL: https://{{ keycloak_hostname_url }}"
          - ""
          - "OIDC Client Details:"
          - "  Client ID: gitlab"
          - "  Realm: master"
          - "  Redirect URI: {{ gitlab_external_url }}/users/auth/openid_connect/callback"
          - ""
          - "Next Steps:"
          - "  1. Visit {{ gitlab_external_url }}"
          - "  2. Look for 'Keycloak SSO' button on login page"
          - "  3. Test authentication flow with anders@viljo.se"
          - "  4. Verify user is created in GitLab after first login"
          - ""
          - "Troubleshooting:"
          - "  - GitLab logs: ssh root@192.168.1.3 'pct exec 153 -- gitlab-ctl tail'"
          - "  - GitLab config: ssh root@192.168.1.3 'pct exec 153 -- grep -A 30 omniauth /etc/gitlab/gitlab.rb'"
          - "  - Keycloak admin: https://{{ keycloak_hostname_url }}/admin"
          - ""
