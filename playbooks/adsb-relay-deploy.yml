---
# Playbook: Deploy ADS-B Data Relay Service
# Description: Deploy ADS-B relay using ADS-B.fi OpenData API
#
# Architecture:
#   api2sbs (polls ADS-B.fi API) -> SBS data -> readsb -> Web UI + Beast TCP
#
# Prerequisites:
#   - LXC 200 with Docker and Traefik
#
# Usage:
#   ansible-playbook playbooks/adsb-relay-deploy.yml

- name: Deploy ADS-B Data Relay Service
  hosts: proxmox_admin
  gather_facts: false

  vars:
    public_domain: viljo.se

  pre_tasks:
    - name: Display deployment plan
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "ADS-B Data Relay Service Deployment"
          - "=========================================="
          - ""
          - "This playbook will deploy:"
          - "  - api2sbs (fetches from ADS-B.fi API)"
          - "  - readsb with web interface"
          - "  - Beast TCP output on port 30005"
          - ""
          - "Data source: ADS-B.fi OpenData API"
          - "Location: {{ adsb_latitude | default(65.8753) }}, {{ adsb_longitude | default(20.15) }} (250NM radius)"
          - "Web UI: https://adsb.{{ public_domain }}"
          - "Beast TCP: adsb.{{ public_domain }}:30005"
          - ""
          - "=========================================="

  roles:
    - adsb_relay

  post_tasks:
    - name: Configure NAT port forwarding for ADS-B ports
      ansible.builtin.shell: |
        # Add NAT rule for Beast TCP output port (30005)
        iptables -t nat -C PREROUTING -i vmbr2 -p tcp --dport 30005 -j DNAT --to-destination 172.31.31.10:30005 2>/dev/null || \
          iptables -t nat -A PREROUTING -i vmbr2 -p tcp --dport 30005 -j DNAT --to-destination 172.31.31.10:30005

        # Add NAT rule for external SBS input port (30006) - for PingStation/remote feeders
        iptables -t nat -C PREROUTING -i vmbr2 -p tcp --dport 30006 -j DNAT --to-destination 172.31.31.10:30006 2>/dev/null || \
          iptables -t nat -A PREROUTING -i vmbr2 -p tcp --dport 30006 -j DNAT --to-destination 172.31.31.10:30006

        # Save rules persistently
        iptables-save > /etc/iptables.rules
      args:
        executable: /bin/bash
      changed_when: false

    - name: Test ADS-B.fi API connectivity
      ansible.builtin.shell: |
        pct exec 200 -- timeout 5 curl -s "https://opendata.adsb.fi/api/v2/lat/65.317/lon/21.479/dist/50" | head -c 200
      register: api_test
      changed_when: false
      failed_when: false

    - name: Display API connectivity status
      ansible.builtin.debug:
        msg: "ADS-B.fi API connectivity: {{ 'OK - receiving data' if api_test.stdout | length > 10 else 'Check connection' }}"

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "ADS-B Data Relay Deployment Complete"
          - "=========================================="
          - ""
          - "Web Interface:"
          - "  URL: https://adsb.{{ public_domain }}"
          - ""
          - "Beast TCP Output:"
          - "  Host: adsb.{{ public_domain }}"
          - "  Port: 30005"
          - "  Protocol: Beast binary format"
          - ""
          - "SBS Input (for remote feeders):"
          - "  Host: adsb.{{ public_domain }}"
          - "  Port: 30006"
          - "  Protocol: SBS/BaseStation text format"
          - "  Use: PingStation, remote feeders can push data here"
          - ""
          - "Data Sources:"
          - "  1. ADS-B.fi OpenData API (worldwide aggregated)"
          - "  2. Raspberry Pi antenna (local real-time)"
          - "  3. ADSBHub feed (worldwide aggregated)"
          - "  4. External SBS input on port 30006"
          - ""
          - "Client Usage Examples:"
          - "  Web: Visit https://adsb.{{ public_domain }}"
          - "  Beast TCP: nc adsb.{{ public_domain }} 30005"
          - "  SBS feed: Connect to adsb.{{ public_domain }}:30006"
          - ""
          - "=========================================="
