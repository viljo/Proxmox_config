---
- name: Deploy Coolify Self-Hosted PaaS Platform
  hosts: proxmox_admin
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Coolify Deployment"
          - "========================================="
          - "Platform: Self-hosted PaaS (Heroku-like)"
          - "Container: {{ coolify_container_id }}"
          - "IP Address: {{ coolify_ip }}"
          - "Domain: coolify.{{ public_domain }}"
          - "Port: 8000 (Docker Compose)"
          - "========================================="

    - name: Verify required vault secrets are configured
      ansible.builtin.assert:
        that:
          - vault_coolify_root_password is defined
          - vault_coolify_postgres_password is defined
          - vault_coolify_redis_password is defined
          - vault_coolify_app_key is defined
          - vault_coolify_pusher_app_secret is defined
        fail_msg: |
          Missing required Coolify vault secrets!

          Please add the following secrets to inventory/group_vars/all/secrets.yml:

          vault_coolify_root_password: "generated-password"
          vault_coolify_postgres_password: "generated-password"
          vault_coolify_redis_password: "generated-password"
          vault_coolify_app_id: "coolify"
          vault_coolify_app_key: "base64:generated-key"
          vault_coolify_pusher_app_secret: "generated-secret"

          Use: ansible-vault edit inventory/group_vars/all/secrets.yml
          See: roles/coolify/VAULT_SECRETS.md for generation instructions
        success_msg: "All required vault secrets are configured ✓"

  roles:
    - role: coolify
      tags: ['coolify']

  post_tasks:
    - name: Wait for Coolify stack to be healthy
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting 30 seconds for Coolify stack to initialize..."

    - name: Verify Coolify container is running
      ansible.builtin.shell: |
        pct status {{ coolify_container_id }}
      register: container_status
      changed_when: false
      failed_when: "'running' not in container_status.stdout"

    - name: Check Coolify Docker Compose stack status
      ansible.builtin.shell: |
        pct exec {{ coolify_container_id }} -- bash -c "cd /opt/coolify && docker compose ps"
      register: compose_status
      changed_when: false

    - name: Display Coolify stack status
      ansible.builtin.debug:
        msg: "{{ compose_status.stdout_lines }}"

    - name: Check Coolify application health
      ansible.builtin.uri:
        url: "http://{{ coolify_ip }}:8000/api/health"
        method: GET
        status_code: [200, 302]
        timeout: 10
      register: health_check
      retries: 3
      delay: 10
      until: health_check.status in [200, 302]
      ignore_errors: true

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - ""
          - "========================================="
          - "Coolify Deployment Complete!"
          - "========================================="
          - ""
          - "Access Information:"
          - "  - URL: https://coolify.{{ public_domain }}"
          - "  - Internal: http://{{ coolify_ip }}:8000"
          - ""
          - "First-Time Setup:"
          - "  1. Open https://coolify.{{ public_domain }} in your browser"
          - "  2. Register the FIRST admin account immediately"
          - "     (First user to register becomes admin!)"
          - "  3. Configure email settings (optional)"
          - "  4. Set up Keycloak OIDC (optional but recommended)"
          - ""
          - "Keycloak SSO Integration:"
          - "  1. Create OIDC client in Keycloak:"
          - "     - Client ID: coolify"
          - "     - Redirect URI: https://coolify.{{ public_domain }}/*"
          - "     - Client authentication: ON"
          - "  2. In Coolify UI: Settings → Authentication → OAuth2"
          - "     - Provider: Custom OpenID Connect"
          - "     - Authorization URL: https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/auth"
          - "     - Token URL: https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/token"
          - "     - User Info URL: https://keycloak.{{ public_domain }}/realms/master/protocol/openid-connect/userinfo"
          - "     - Client ID: coolify"
          - "     - Client Secret: <from Keycloak>"
          - ""
          - "Container Management:"
          - "  - SSH: pct enter {{ coolify_container_id }}"
          - "  - Logs: pct exec {{ coolify_container_id }} -- bash -c 'cd /opt/coolify && docker compose logs -f'"
          - "  - Restart: pct exec {{ coolify_container_id }} -- bash -c 'cd /opt/coolify && docker compose restart'"
          - ""
          - "Documentation:"
          - "  - Role README: roles/coolify/README.md"
          - "  - Vault Secrets: roles/coolify/VAULT_SECRETS.md"
          - "  - Coolify Docs: https://coolify.io/docs"
          - ""
          - "Next Steps:"
          - "  1. Register admin account NOW (before exposing to users)"
          - "  2. Configure Keycloak SSO"
          - "  3. Deploy your first application"
          - "  4. Test git repository integration"
          - ""
          - "⚠️  SECURITY: Register admin account immediately!"
          - "   First user to register becomes admin with full access."
          - ""
          - "========================================="
