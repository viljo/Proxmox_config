---
# Playbook: Deploy Media Services Stack
# Description: Deploy complete media services infrastructure (Jellyfin + qBittorrent)
# Specs:
#   - specs/planned/009-jellyfin-media-server
#   - specs/planned/009-bittorrent-client

- name: Deploy Media Services Stack
  hosts: proxmox_admin
  gather_facts: false

  pre_tasks:
    - name: Display deployment plan
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Media Services Stack Deployment"
          - "=========================================="
          - "This playbook will deploy:"
          - "1. qBittorrent - BitTorrent client (torrent.{{ public_domain }})"
          - "2. Jellyfin - Media server (media.{{ public_domain }})"
          - ""
          - "Deployment target: Containers LXC 200"
          - "All services deployed as Docker containers"
          - "Directly accessible (no SSO protection)"
          - ""
          - "qBittorrent Configuration:"
          - "  - Torrent Port: 6881 (TCP/UDP)"
          - "  - WebUI Port: 8080 (via Traefik)"
          - "  - Password: From Ansible vault"
          - "=========================================="

    - name: Ensure host media storage directory exists
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - /srv/media
        - /srv/media/downloads
        - /srv/media/movies
        - /srv/media/tv
        - /srv/media/music

  tasks:
    - name: Configure NAT port forwarding for qBittorrent
      ansible.builtin.shell: |
        # Add NAT rules for BitTorrent port 6881 (TCP/UDP)
        iptables -t nat -C PREROUTING -i vmbr2 -p tcp --dport 6881 -j DNAT --to-destination 172.31.31.10:6881 2>/dev/null || \
          iptables -t nat -A PREROUTING -i vmbr2 -p tcp --dport 6881 -j DNAT --to-destination 172.31.31.10:6881

        iptables -t nat -C PREROUTING -i vmbr2 -p udp --dport 6881 -j DNAT --to-destination 172.31.31.10:6881 2>/dev/null || \
          iptables -t nat -A PREROUTING -i vmbr2 -p udp --dport 6881 -j DNAT --to-destination 172.31.31.10:6881

        # Save rules persistently
        mkdir -p /etc/iptables
        iptables-save > /etc/iptables/rules.v4
      args:
        executable: /bin/bash
      changed_when: false
      tags:
        - qbittorrent
        - firewall

    - name: Deploy qBittorrent BitTorrent Client
      ansible.builtin.import_role:
        name: qbittorrent
      tags:
        - qbittorrent
        - downloads

    - name: Deploy Jellyfin Media Server
      ansible.builtin.include_role:
        name: jellyfin
      tags:
        - jellyfin
        - media

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Media Services Stack Deployment Complete"
          - "=========================================="
          - ""
          - "✅ qBittorrent BitTorrent Client:"
          - "  External URL: https://torrent.{{ public_domain }}"
          - "  Username: admin"
          - "  Password: {{ vault_qbittorrent_root_password }}"
          - "  Torrent Port: 6881 (TCP/UDP)"
          - "  NAT Forwarding: Public IP → 172.31.31.10:6881 (Configured)"
          - "  Authentication: qBittorrent native (no SSO)"
          - ""
          - "✅ Jellyfin Media Server:"
          - "  External URL: https://media.{{ public_domain }}"
          - "  Authentication: Jellyfin native (no SSO)"
          - "  Admin user: Set up via web wizard on first access"
          - ""
          - "=========================================="
          - "NEXT STEPS"
          - "=========================================="
          - ""
          - "1. Configure qBittorrent Password (REQUIRED):"
          - "   a. Access: https://torrent.{{ public_domain }}"
          - "   b. Login with temporary password from container logs"
          - "   c. Go to Tools → Options → Web UI"
          - "   d. Set password to: {{ vault_qbittorrent_root_password }}"
          - "   e. Click Save"
          - ""
          - "2. Verify NAT Port Forwarding (Configured Automatically):"
          - "   a. Check NAT rules: iptables -t nat -L PREROUTING -n -v | grep 6881"
          - "   b. Should show: vmbr2:6881 → 172.31.31.10:6881 (TCP/UDP)"
          - "   c. Test port at: https://www.yougetsignal.com/tools/open-ports/"
          - "   d. Or use qBittorrent: Tools → Options → Connection → Test Port"
          - ""
          - "3. Configure Jellyfin Media Libraries:"
          - "   a. Access: https://media.{{ public_domain }}/web/index.html#!/dashboard"
          - "   b. Go to Dashboard → Libraries"
          - "   c. Add media libraries:"
          - "      - Movies: /media/movies"
          - "      - TV Shows: /media/tv"
          - "      - Music: /media/music"
          - "      - Downloads: /media/downloads"
          - ""
          - "4. Test Media Workflow:"
          - "   a. Download a test file (e.g., Ubuntu ISO) via qBittorrent"
          - "   b. Wait for download to complete"
          - "   c. Trigger Jellyfin library scan"
          - "   d. Verify file appears in Jellyfin"
          - ""
          - "5. Verify qBittorrent Port Configuration:"
          - "   a. Check container ports: docker port qbittorrent"
          - "   b. Should show: 6881/tcp -> 0.0.0.0:6881"
          - "   c. Should show: 6881/udp -> 0.0.0.0:6881"
          - ""
          - "=========================================="

    - name: Final success message
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "SUCCESS! Media Services Stack is Running"
          - "=========================================="
          - "All services are deployed and directly accessible."
          - "Follow the next steps above to complete configuration."
          - "=========================================="
