---
# Playbook: Deploy Media Services Stack
# Description: Deploy complete media services infrastructure (Jellyfin + qBittorrent)
# Specs:
#   - specs/planned/009-jellyfin-media-server
#   - specs/planned/009-bittorrent-client

- name: Deploy Media Services Stack
  hosts: proxmox_admin
  gather_facts: false

  pre_tasks:
    - name: Display deployment plan
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Media Services Stack Deployment"
          - "=========================================="
          - "This playbook will deploy:"
          - "1. qBittorrent - BitTorrent client (torrent.{{ public_domain }})"
          - "2. Jellyfin - Media server (media.{{ public_domain }})"
          - ""
          - "Deployment target: Coolify LXC 200"
          - "All services deployed as Docker containers"
          - "Directly accessible (no SSO protection)"
          - "=========================================="

    - name: Ensure host media storage directory exists
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - /srv/media
        - /srv/media/downloads
        - /srv/media/movies
        - /srv/media/tv
        - /srv/media/music

  tasks:
    - name: Deploy qBittorrent BitTorrent Client
      ansible.builtin.import_role:
        name: qbittorrent
      tags:
        - qbittorrent
        - downloads

    - name: Deploy Jellyfin Media Server
      ansible.builtin.include_role:
        name: jellyfin
      tags:
        - jellyfin
        - media

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Media Services Stack Deployment Complete"
          - "=========================================="
          - ""
          - "✅ qBittorrent BitTorrent Client:"
          - "  External URL: https://torrent.{{ public_domain }}"
          - "  Protected by: OAuth2-Proxy (GitLab SSO)"
          - ""
          - "✅ Jellyfin Media Server:"
          - "  External URL: https://media.{{ public_domain }}"
          - "  Protected by: OAuth2-Proxy (GitLab SSO)"
          - "  Admin user: {{ jellyfin_admin_username }}"
          - "  Wizard: {% if jellyfin_skip_wizard %}Automatically completed{% else %}Manual setup required{% endif %}"
          - ""
          - "=========================================="
          - "NEXT STEPS"
          - "=========================================="
          - ""
          - "1. Access Services (Directly Accessible):"
          - "   - qBittorrent: https://torrent.{{ public_domain }}"
          - "   - Jellyfin: https://media.{{ public_domain }}"
          - "   - Each service uses its own authentication"
          - ""
          - "2. Configure Jellyfin Media Libraries:"
          - "   a. Access: https://media.{{ public_domain }}/web/index.html#!/dashboard"
          - "   b. Go to Dashboard → Libraries"
          - "   c. Add media libraries:"
          - "      - Movies: /media/movies"
          - "      - TV Shows: /media/tv"
          - "      - Music: /media/music"
          - "      - Downloads: /media/downloads"
          - ""
          - "3. Test Media Workflow:"
          - "   a. Download a test file (e.g., Ubuntu ISO) via qBittorrent"
          - "   b. Wait for download to complete"
          - "   c. Trigger Jellyfin library scan"
          - "   d. Verify file appears in Jellyfin"
          - ""
          - "=========================================="

    - name: Final success message
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "SUCCESS! Media Services Stack is Running"
          - "=========================================="
          - "All services are deployed and directly accessible."
          - "Follow the next steps above to complete configuration."
          - "=========================================="
