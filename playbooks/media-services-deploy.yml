---
# Playbook: Deploy Media Services Stack
# Description: Deploy complete media services infrastructure (Jellyfin + qBittorrent)
# Specs:
#   - specs/planned/009-jellyfin-media-server
#   - specs/planned/009-bittorrent-client

- name: Deploy Media Services Stack
  hosts: proxmox_admin
  gather_facts: false

  vars:
    deployment_services:
      - name: qBittorrent
        container_id: "{{ qbittorrent_container_id }}"
        ip: "{{ qbittorrent_ip_address }}"
        domain: "qbittorrent.{{ public_domain }}"
      - name: Jellyfin
        container_id: "{{ jellyfin_container_id }}"
        ip: "{{ jellyfin_ip_address }}"
        domain: "jellyfin.{{ public_domain }}"

  pre_tasks:
    - name: Display deployment plan
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Media Services Stack Deployment"
          - "=========================================="
          - "This playbook will deploy:"
          - "1. qBittorrent (ID: {{ qbittorrent_container_id }}) - BitTorrent client"
          - "2. Jellyfin (ID: {{ jellyfin_container_id }}) - Media server"
          - ""
          - "Integration:"
          - "  - qBittorrent downloads to: {{ qbittorrent_complete_dir }}"
          - "  - Jellyfin accesses media from: /media/downloads"
          - "  - Shared storage on host: {{ qbittorrent_host_download_path }}"
          - "=========================================="

    - name: Validate all required variables
      ansible.builtin.assert:
        that:
          - jellyfin_container_id is defined
          - qbittorrent_container_id is defined
          - jellyfin_ip_address is defined
          - qbittorrent_ip_address is defined
          - jellyfin_root_password is defined
          - qbittorrent_root_password is defined
        fail_msg: "Required configuration variables are missing"
        success_msg: "All required variables are defined"

    - name: Ensure host media storage directory exists
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - /srv/media
        - /srv/media/downloads
        - /srv/media/movies
        - /srv/media/tv
        - /srv/media/music

  tasks:
    - name: Deploy qBittorrent BitTorrent Client
      ansible.builtin.import_role:
        name: qbittorrent
      tags:
        - qbittorrent
        - downloads

    - name: Deploy Jellyfin Media Server
      ansible.builtin.include_role:
        name: jellyfin
      tags:
        - jellyfin
        - media

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Media Services Stack Deployment Complete"
          - "=========================================="
          - ""
          - "✅ qBittorrent BitTorrent Client:"
          - "  External URL: https://torrent.{{ public_domain }}"
          - "  Protected by: OAuth2-Proxy (GitLab SSO)"
          - ""
          - "✅ Jellyfin Media Server:"
          - "  External URL: https://media.{{ public_domain }}"
          - "  Protected by: OAuth2-Proxy (GitLab SSO)"
          - "  Admin user: {{ jellyfin_admin_username }}"
          - "  Wizard: {% if jellyfin_skip_wizard %}Automatically completed{% else %}Manual setup required{% endif %}"
          - ""
          - "=========================================="
          - "NEXT STEPS"
          - "=========================================="
          - ""
          - "1. Access Services (SSO Protected):"
          - "   - qBittorrent: https://torrent.{{ public_domain }}"
          - "   - Jellyfin: https://media.{{ public_domain }}"
          - "   - Login with GitLab.com account (@viljo.se email required)"
          - ""
          - "2. Configure Jellyfin Media Libraries:"
          - "   a. Access: https://media.{{ public_domain }}/web/index.html#!/dashboard"
          - "   b. Go to Dashboard → Libraries"
          - "   c. Add media libraries:"
          - "      - Movies: /media/movies"
          - "      - TV Shows: /media/tv"
          - "      - Music: /media/music"
          - "      - Downloads: /media/downloads"
          - ""
          - "3. Test Media Workflow:"
          - "   a. Download a test file (e.g., Ubuntu ISO) via qBittorrent"
          - "   b. Wait for download to complete"
          - "   c. Trigger Jellyfin library scan"
          - "   d. Verify file appears in Jellyfin"
          - ""
          - "=========================================="

    - name: Final success message
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "SUCCESS! Media Services Stack is Running"
          - "=========================================="
          - "All services are deployed and protected by SSO."
          - "Follow the next steps above to complete configuration."
          - "=========================================="
